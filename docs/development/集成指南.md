# é›†æˆæŒ‡å— - å°†æŠ¢ç¥¨è„šæœ¬é›†æˆåˆ°GUI

## ç›®æ ‡

å°† `damai_ticket_bot.py` çš„å®Œæ•´æŠ¢ç¥¨æµç¨‹é›†æˆåˆ°ç°æœ‰çš„ `damai_smart_ai.py` GUIä¸­,å®ç°ä¸€é”®è‡ªåŠ¨æŠ¢ç¥¨åŠŸèƒ½ã€‚

---

## é›†æˆæ–¹æ¡ˆ

### æ–¹æ¡ˆ1: åœ¨GUIä¸­æ·»åŠ "ä¸€é”®æŠ¢ç¥¨"æŒ‰é’® (æ¨è)

åœ¨ç°æœ‰GUIä¸­æ·»åŠ ä¸€ä¸ªæ–°æŒ‰é’®,ç‚¹å‡»åè°ƒç”¨`DamaiTicketBot`æ‰§è¡Œå®Œæ•´æµç¨‹ã€‚

**ä¼˜ç‚¹:**
- ç®€å•ç›´æ¥
- ä¸å½±å“ç°æœ‰OCRåŠŸèƒ½
- å¯ä»¥ä¸¤ç§æ¨¡å¼å¹¶å­˜

**æ­¥éª¤:**

#### 1. å¯¼å…¥DamaiTicketBotç±»

åœ¨ `damai_smart_ai.py` é¡¶éƒ¨æ·»åŠ :

```python
from damai_ticket_bot import DamaiTicketBot
```

#### 2. åœ¨GUIç±»ä¸­æ·»åŠ åŸå¸‚å’Œå…³é”®è¯è¾“å…¥æ¡†

æ‰¾åˆ°GUIåˆå§‹åŒ–éƒ¨åˆ†,æ·»åŠ è¾“å…¥æ¡†å˜é‡:

```python
# åœ¨ __init__ æ–¹æ³•ä¸­æ·»åŠ 
self.auto_city_var = tk.StringVar(value="åŒ—äº¬")
self.auto_keyword_var = tk.StringVar(value="")
self.enable_queue_retry_var = tk.BooleanVar(value=False)
self.max_queue_retries_var = tk.StringVar(value="200")
```

#### 3. åœ¨GUIç•Œé¢æ·»åŠ æ§åˆ¶åŒºåŸŸ

æ‰¾åˆ°åˆ›å»ºç•Œé¢çš„éƒ¨åˆ†,æ·»åŠ æ–°çš„é…ç½®åŒºåŸŸ:

```python
# åœ¨create_widgetsæˆ–ç±»ä¼¼æ–¹æ³•ä¸­æ·»åŠ 

# ä¸€é”®æŠ¢ç¥¨é…ç½®åŒºåŸŸ
auto_frame = ttk.LabelFrame(control_frame, text=" ä¸€é”®æŠ¢ç¥¨é…ç½® ", padding=10)
auto_frame.pack(fill=tk.X, pady=5)

# åŸå¸‚è¾“å…¥
tk.Label(auto_frame, text="åŸå¸‚:", font=('å¾®è½¯é›…é»‘', 10)).grid(row=0, column=0, sticky=tk.W, padx=5, pady=5)
tk.Entry(auto_frame, textvariable=self.auto_city_var, width=15).grid(row=0, column=1, sticky=tk.W, padx=5, pady=5)

# å…³é”®è¯è¾“å…¥
tk.Label(auto_frame, text="æ¼”å‡ºå…³é”®è¯:", font=('å¾®è½¯é›…é»‘', 10)).grid(row=1, column=0, sticky=tk.W, padx=5, pady=5)
tk.Entry(auto_frame, textvariable=self.auto_keyword_var, width=30).grid(row=1, column=1, columnspan=2, sticky=tk.W, padx=5, pady=5)

# æ’é˜Ÿé‡è¯•é€‰é¡¹
tk.Checkbutton(auto_frame, text="å¯ç”¨æ’é˜Ÿé‡è¯•", variable=self.enable_queue_retry_var).grid(row=2, column=0, sticky=tk.W, padx=5, pady=5)
tk.Label(auto_frame, text="é‡è¯•æ¬¡æ•°:", font=('å¾®è½¯é›…é»‘', 9)).grid(row=2, column=1, sticky=tk.W, padx=5, pady=5)
tk.Entry(auto_frame, textvariable=self.max_queue_retries_var, width=10).grid(row=2, column=2, sticky=tk.W, padx=5, pady=5)

# ä¸€é”®æŠ¢ç¥¨æŒ‰é’®
auto_button = tk.Button(auto_frame,
                        text="ğŸ« ä¸€é”®æŠ¢ç¥¨",
                        font=('å¾®è½¯é›…é»‘', 12, 'bold'),
                        bg='#FF5722',
                        fg='white',
                        width=20,
                        height=2,
                        command=self.start_auto_ticket,
                        cursor='hand2')
auto_button.grid(row=3, column=0, columnspan=3, pady=10)
```

#### 4. å®ç°ä¸€é”®æŠ¢ç¥¨æ–¹æ³•

åœ¨GUIç±»ä¸­æ·»åŠ æ–¹æ³•:

```python
def start_auto_ticket(self):
    """ä¸€é”®æŠ¢ç¥¨åŠŸèƒ½"""
    # éªŒè¯é…ç½®
    city = self.auto_city_var.get().strip()
    keyword = self.auto_keyword_var.get().strip()

    if not city:
        messagebox.showerror("é…ç½®é”™è¯¯", "è¯·è¾“å…¥ç›®æ ‡åŸå¸‚!")
        return

    if not keyword:
        messagebox.showerror("é…ç½®é”™è¯¯", "è¯·è¾“å…¥æ¼”å‡ºå…³é”®è¯!")
        return

    # è¯¢é—®ç¡®è®¤
    if not messagebox.askyesno("ç¡®è®¤",
        f"å³å°†å¼€å§‹æŠ¢ç¥¨:\n\nåŸå¸‚: {city}\næ¼”å‡º: {keyword}\n\nç¡®å®šå¼€å§‹å—?"):
        return

    # ç¦ç”¨æŒ‰é’®,é˜²æ­¢é‡å¤ç‚¹å‡»
    # auto_button.config(state=tk.DISABLED)  # éœ€è¦ä¿å­˜æŒ‰é’®å¼•ç”¨

    # åœ¨æ–°çº¿ç¨‹ä¸­è¿è¡Œ
    thread = threading.Thread(target=self._run_auto_ticket_thread,
                             args=(city, keyword),
                             daemon=True)
    thread.start()

def _run_auto_ticket_thread(self, city, keyword):
    """åœ¨çº¿ç¨‹ä¸­è¿è¡ŒæŠ¢ç¥¨æµç¨‹"""
    try:
        # åˆ›å»ºbotå®ä¾‹
        bot = DamaiTicketBot()

        # é…ç½®å‚æ•°
        bot.config['city'] = city
        bot.config['keyword'] = keyword
        bot.config['adb_port'] = self.config.get('adb_port', '62616')

        # é…ç½®é‡è¯•
        if self.enable_queue_retry_var.get():
            bot.retry_config['max_queue_retries'] = int(self.max_queue_retries_var.get())

        # é‡å®šå‘æ—¥å¿—åˆ°GUI
        original_log = bot.log
        def gui_log(message, level="INFO"):
            # å°†æ—¥å¿—è¾“å‡ºåˆ°GUIçš„æ—¥å¿—æ¡†
            timestamp = datetime.now().strftime("%H:%M:%S")
            log_msg = f"[{timestamp}] [{level}] {message}"

            # çº¿ç¨‹å®‰å…¨åœ°æ›´æ–°GUI
            self.root.after(0, lambda: self.add_log(log_msg, level))

        bot.log = gui_log

        # æ‰§è¡ŒæŠ¢ç¥¨
        gui_log("========== å¼€å§‹è‡ªåŠ¨æŠ¢ç¥¨ ==========", "STEP")
        success = bot.run(enable_queue_retry=self.enable_queue_retry_var.get())

        # æ˜¾ç¤ºç»“æœ
        if success:
            self.root.after(0, lambda: messagebox.showinfo("æˆåŠŸ", "æŠ¢ç¥¨æµç¨‹æ‰§è¡Œå®Œæˆ!"))
        else:
            self.root.after(0, lambda: messagebox.showerror("å¤±è´¥", "æŠ¢ç¥¨æµç¨‹æ‰§è¡Œå¤±è´¥,è¯·æŸ¥çœ‹æ—¥å¿—!"))

    except Exception as e:
        error_msg = f"æŠ¢ç¥¨å‡ºé”™: {str(e)}"
        self.root.after(0, lambda: messagebox.showerror("é”™è¯¯", error_msg))
        self.root.after(0, lambda: self.add_log(error_msg, "ERROR"))

    finally:
        # æ¢å¤æŒ‰é’®çŠ¶æ€
        # self.root.after(0, lambda: auto_button.config(state=tk.NORMAL))
        pass

def add_log(self, message, level="INFO"):
    """æ·»åŠ æ—¥å¿—åˆ°GUI (çº¿ç¨‹å®‰å…¨)"""
    # å¦‚æœGUIå·²æœ‰æ—¥å¿—æ¡†,è¿½åŠ æ—¥å¿—
    if hasattr(self, 'log_text'):
        self.log_text.config(state=tk.NORMAL)

        # æ ¹æ®çº§åˆ«è®¾ç½®é¢œè‰²
        tag = level.lower()
        self.log_text.insert(tk.END, message + "\n", tag)
        self.log_text.see(tk.END)
        self.log_text.config(state=tk.DISABLED)
```

---

### æ–¹æ¡ˆ2: å®Œå…¨æ›¿æ¢ä¸ºæ–°çš„æŠ¢ç¥¨æ¨¡å¼

å°†GUIçš„é»˜è®¤è¡Œä¸ºæ”¹ä¸ºä½¿ç”¨`damai_ticket_bot.py`çš„æµç¨‹ã€‚

**ä¼˜ç‚¹:**
- ç»Ÿä¸€çš„æŠ¢ç¥¨é€»è¾‘
- æ›´ç¨³å®šå¯é 

**ç¼ºç‚¹:**
- éœ€è¦è¾ƒå¤§æ”¹åŠ¨
- å¤±å»OCRæ™ºèƒ½è¯†åˆ«åŠŸèƒ½

**ä¸æ¨è**,å»ºè®®ä½¿ç”¨æ–¹æ¡ˆ1,è®©ä¸¤ç§æ¨¡å¼å¹¶å­˜ã€‚

---

## å®Œæ•´é›†æˆç¤ºä¾‹ä»£ç 

åˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶ `damai_integrated_gui.py`,å®Œæ•´é›†æˆç‰ˆæœ¬:

```python
#!/usr/bin/env python
# -*- coding: UTF-8 -*-
"""
å¤§éº¦æŠ¢ç¥¨ - é›†æˆç‰ˆGUI
ç»“åˆOCRæ™ºèƒ½ç›‘æ§ + ä¸€é”®æŠ¢ç¥¨åŠŸèƒ½
"""

import tkinter as tk
from tkinter import ttk, scrolledtext, messagebox
import threading
from datetime import datetime

# å¯¼å…¥ç°æœ‰åŠŸèƒ½
from damai_smart_ai import DamaiMonitorGUI  # å‡è®¾åŸGUIç±»å

# å¯¼å…¥æ–°çš„æŠ¢ç¥¨è„šæœ¬
from damai_ticket_bot import DamaiTicketBot


class IntegratedDamaiGUI(DamaiMonitorGUI):
    """é›†æˆç‰ˆGUI - ç»§æ‰¿åŸGUIå¹¶æ·»åŠ ä¸€é”®æŠ¢ç¥¨åŠŸèƒ½"""

    def __init__(self, root):
        # è°ƒç”¨çˆ¶ç±»åˆå§‹åŒ–
        super().__init__(root)

        # æ·»åŠ ä¸€é”®æŠ¢ç¥¨ç›¸å…³å˜é‡
        self.auto_city_var = tk.StringVar(value="åŒ—äº¬")
        self.auto_keyword_var = tk.StringVar(value="")
        self.enable_queue_retry_var = tk.BooleanVar(value=False)
        self.max_queue_retries_var = tk.StringVar(value="200")

        # æ·»åŠ ä¸€é”®æŠ¢ç¥¨UI
        self.add_auto_ticket_ui()

    def add_auto_ticket_ui(self):
        """æ·»åŠ ä¸€é”®æŠ¢ç¥¨UIç»„ä»¶"""
        # åˆ›å»ºæ–°çš„Frame
        auto_frame = ttk.LabelFrame(self.control_frame,
                                   text=" ä¸€é”®æŠ¢ç¥¨ (æ–°åŠŸèƒ½) ",
                                   padding=10)
        auto_frame.pack(fill=tk.X, pady=10)

        # åŸå¸‚
        row = 0
        tk.Label(auto_frame, text="åŸå¸‚:").grid(row=row, column=0, sticky=tk.W, padx=5, pady=5)
        tk.Entry(auto_frame, textvariable=self.auto_city_var, width=15).grid(
            row=row, column=1, sticky=tk.W, padx=5, pady=5)

        # å…³é”®è¯
        row += 1
        tk.Label(auto_frame, text="æ¼”å‡º:").grid(row=row, column=0, sticky=tk.W, padx=5, pady=5)
        tk.Entry(auto_frame, textvariable=self.auto_keyword_var, width=30).grid(
            row=row, column=1, columnspan=2, sticky=tk.W, padx=5, pady=5)

        # é‡è¯•é€‰é¡¹
        row += 1
        tk.Checkbutton(auto_frame, text="å¯ç”¨æ’é˜Ÿé‡è¯•",
                      variable=self.enable_queue_retry_var).grid(
            row=row, column=0, sticky=tk.W, padx=5, pady=5)
        tk.Label(auto_frame, text="æ¬¡æ•°:").grid(row=row, column=1, sticky=tk.W, padx=5, pady=5)
        tk.Entry(auto_frame, textvariable=self.max_queue_retries_var, width=10).grid(
            row=row, column=2, sticky=tk.W, padx=5, pady=5)

        # æŠ¢ç¥¨æŒ‰é’®
        row += 1
        tk.Button(auto_frame,
                 text="ğŸ« å¼€å§‹ä¸€é”®æŠ¢ç¥¨",
                 font=('å¾®è½¯é›…é»‘', 12, 'bold'),
                 bg='#FF5722',
                 fg='white',
                 width=25,
                 height=2,
                 command=self.start_auto_ticket).grid(
            row=row, column=0, columnspan=3, pady=10)

    def start_auto_ticket(self):
        """å¯åŠ¨ä¸€é”®æŠ¢ç¥¨"""
        city = self.auto_city_var.get().strip()
        keyword = self.auto_keyword_var.get().strip()

        if not city or not keyword:
            messagebox.showerror("é”™è¯¯", "è¯·è¾“å…¥åŸå¸‚å’Œæ¼”å‡ºå…³é”®è¯!")
            return

        if messagebox.askyesno("ç¡®è®¤",
            f"å¼€å§‹æŠ¢ç¥¨:\nåŸå¸‚: {city}\næ¼”å‡º: {keyword}\n\nç¡®å®šå—?"):
            thread = threading.Thread(target=self._run_auto_ticket,
                                     args=(city, keyword),
                                     daemon=True)
            thread.start()

    def _run_auto_ticket(self, city, keyword):
        """æ‰§è¡ŒæŠ¢ç¥¨"""
        try:
            bot = DamaiTicketBot()
            bot.config['city'] = city
            bot.config['keyword'] = keyword
            bot.config['adb_port'] = self.config.get('adb_port', '62616')

            # é‡å®šå‘æ—¥å¿—
            def gui_log(msg, level="INFO"):
                timestamp = datetime.now().strftime("%H:%M:%S")
                log_msg = f"[{timestamp}] [{level}] {msg}"
                self.root.after(0, lambda: self.log(log_msg))

            bot.log = gui_log

            # è¿è¡Œ
            success = bot.run(enable_queue_retry=self.enable_queue_retry_var.get())

            # ç»“æœæç¤º
            if success:
                self.root.after(0, lambda: messagebox.showinfo("å®Œæˆ", "æŠ¢ç¥¨æµç¨‹å·²å®Œæˆ!"))
            else:
                self.root.after(0, lambda: messagebox.showerror("å¤±è´¥", "æŠ¢ç¥¨å¤±è´¥,è¯·æŸ¥çœ‹æ—¥å¿—"))

        except Exception as e:
            self.root.after(0, lambda: messagebox.showerror("é”™è¯¯", str(e)))


def main():
    root = tk.Tk()
    app = IntegratedDamaiGUI(root)
    root.mainloop()


if __name__ == "__main__":
    main()
```

---

## ä½¿ç”¨æ–¹æ³•

### é€‰é¡¹1: ç›´æ¥ä¿®æ”¹ damai_smart_ai.py

1. åœ¨æ–‡ä»¶é¡¶éƒ¨æ·»åŠ å¯¼å…¥:
   ```python
   from damai_ticket_bot import DamaiTicketBot
   ```

2. æŒ‰ç…§"æ–¹æ¡ˆ1"çš„æ­¥éª¤æ·»åŠ UIå’Œæ–¹æ³•

3. è¿è¡Œ:
   ```bash
   python damai_smart_ai.py
   ```

### é€‰é¡¹2: åˆ›å»ºæ–°çš„é›†æˆç‰ˆGUI

1. åˆ›å»º `damai_integrated_gui.py`

2. å¤åˆ¶ä¸Šé¢çš„å®Œæ•´ç¤ºä¾‹ä»£ç 

3. è¿è¡Œ:
   ```bash
   python damai_integrated_gui.py
   ```

### é€‰é¡¹3: ä¿æŒç‹¬ç«‹ä½¿ç”¨

ä¸åšé›†æˆ,ç»§ç»­ä½¿ç”¨:
- `damai_smart_ai.py` - OCRæ™ºèƒ½ç›‘æ§
- `damai_ticket_bot.py` - å‘½ä»¤è¡ŒæŠ¢ç¥¨
- `damai_gui.py` - ç®€å•GUIæŠ¢ç¥¨

---

## é…ç½®è¯´æ˜

### å¿…å¡«å‚æ•°

- **åŸå¸‚**: ä¾‹å¦‚"åŒ—äº¬"ã€"ä¸Šæµ·"ã€"å—äº¬"
- **æ¼”å‡ºå…³é”®è¯**: ä¾‹å¦‚"2025é»æ˜å·¡å›æ¼”å”±ä¼š"

### å¯é€‰å‚æ•°

- **å¯ç”¨æ’é˜Ÿé‡è¯•**: é‡åˆ°æ’é˜Ÿæ—¶è‡ªåŠ¨é‡è¯•
- **é‡è¯•æ¬¡æ•°**: é»˜è®¤200æ¬¡,çƒ­é—¨æ¼”å‡ºå»ºè®®è®¾ç½®æ›´é«˜(å¦‚500)

### é«˜çº§é…ç½®

åœ¨`damai_appium/config.jsonc`ä¸­é…ç½®:
- `adb_port`: è®¾å¤‡ç«¯å£
- `server_url`: AppiumæœåŠ¡åœ°å€

---

## æ³¨æ„äº‹é¡¹

### 1. åæ ‡é…ç½®

åœºæ¬¡/ç¥¨æ¡£çš„åæ ‡å¯èƒ½å› æ¼”å‡ºè€Œå¼‚,ä½¿ç”¨å‰è¯·:

```bash
# æ‰‹åŠ¨è¿›å…¥ç›®æ ‡æ¼”å‡ºé¡µé¢,æµ‹è¯•åæ ‡
adb shell input tap 209 435  # åœºæ¬¡
adb shell input tap 169 659  # ç¥¨æ¡£
adb shell input tap 558 1233 # ç¡®è®¤
```

å¦‚éœ€è°ƒæ•´,ä¿®æ”¹`damai_ticket_bot.py`ä¸­çš„åæ ‡é…ç½®ã€‚

### 2. æ»‘å—éªŒè¯

ç‚¹å‡»"ç«‹å³è´­ç¥¨"åå¯èƒ½å‡ºç°æ»‘å—éªŒè¯,éœ€è¦æ‰‹åŠ¨å®Œæˆã€‚

### 3. æ—¥å¿—è¾“å‡º

æ‰€æœ‰æ—¥å¿—ä¼šè¾“å‡ºåˆ°GUIçš„æ—¥å¿—æ¡†,ä¾¿äºç›‘æ§æµç¨‹ã€‚

### 4. çº¿ç¨‹å®‰å…¨

GUIæ›´æ–°ä½¿ç”¨`root.after(0, lambda: ...)`ç¡®ä¿çº¿ç¨‹å®‰å…¨ã€‚

---

## æµ‹è¯•å»ºè®®

### 1. å…ˆæµ‹è¯•åŸºç¡€åŠŸèƒ½

```bash
# å‘½ä»¤è¡Œæµ‹è¯•
python damai_ticket_bot.py --city æµ‹è¯•åŸå¸‚ --keyword "æµ‹è¯•æ¼”å‡º"
```

### 2. ç¡®è®¤åæ ‡å‡†ç¡®

ä½¿ç”¨`test_ticket_flow.py`æµ‹è¯•å„æ­¥éª¤ã€‚

### 3. æ­£å¼æŠ¢ç¥¨å‰æ¼”ç»ƒ

ä½¿ç”¨å†·é—¨æ¼”å‡ºå®Œæ•´æµ‹è¯•ä¸€éæµç¨‹ã€‚

---

## ä¸‹ä¸€æ­¥ä¼˜åŒ–

1. **è‡ªåŠ¨æ»‘å—è¯†åˆ«**
   - é›†æˆæ»‘å—è¯†åˆ«ç®—æ³•
   - è‡ªåŠ¨å®ŒæˆéªŒè¯

2. **åæ ‡è‡ªé€‚åº”**
   - OCRè¯†åˆ«æŒ‰é’®ä½ç½®
   - è‡ªåŠ¨è®¡ç®—ç‚¹å‡»åæ ‡

3. **å®šæ—¶æŠ¢ç¥¨**
   - è®¾ç½®å¼€æŠ¢æ—¶é—´
   - å€’è®¡æ—¶è‡ªåŠ¨æ‰§è¡Œ

4. **å¤šè®¾å¤‡å¹¶å‘**
   - æ”¯æŒå¤šä¸ªADBç«¯å£
   - å¹¶å‘æ‰§è¡Œæé«˜æˆåŠŸç‡

---

ç”Ÿæˆæ—¶é—´: 2025-11-15
ç‰ˆæœ¬: v1.0
