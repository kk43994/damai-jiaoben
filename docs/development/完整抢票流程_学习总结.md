# 大麦抢票完整流程 - 学习总结

**学习日期**: 2025-11-16
**参考文件**:
- `learn_complete_flow.py` - 流程学习脚本
- `damai_ticket_bot.py` - 生产级抢票机器人
- `damai_smart_ai.py` - 智能AI系统
- `coordinate_manager.py` - 坐标管理系统
- `页面样式/` - 10张真实页面截图

---

## 完整抢票流程 (10步)

### 步骤0: 准备工作

**前置条件**:
1. ✅ ADB已连接设备
2. ✅ Appium服务器正在运行 (http://127.0.0.1:4723)
3. ✅ 大麦APP已安装并打开
4. ✅ 配置文件已准备 (config.jsonc)

**配置参数**:
```json
{
  "adb_port": "64562",        // ADB端口
  "city": "北京",              // 目标城市
  "keyword": "2025黎明南京",   // 搜索关键词
  "server_url": "http://127.0.0.1:4723"
}
```

---

### 步骤1: 连接Appium

**目标**: 建立与设备的WebDriver连接

**关键代码**:
```python
from appium import webdriver
from appium.options.android import UiAutomator2Options

options = UiAutomator2Options()
options.platform_name = "Android"
options.udid = f"127.0.0.1:{adb_port}"
options.app_package = "cn.damai"
options.app_activity = "cn.damai.main.ui.MainActivity"
options.no_reset = True
options.new_command_timeout = 600  # 10分钟超时

driver = webdriver.Remote('http://127.0.0.1:4723', options=options)
```

**验证**:
- 连接成功不报错
- 可以获取`driver.current_activity`

**注意事项**:
- 首次连接可能需要60-140秒
- 使用WebDriver管理器可复用连接,第2次仅需<1秒

---

### 步骤2: 等待首页加载

**目标**: 确保APP已进入首页,关闭所有弹窗

**页面特征** (参考截图):
- ✅ 底部导航栏: "首页"、"影院场馆"、"大麦VIP"、"发现"、"我的"
- ✅ 分类导航: "演唱会"、"话剧音乐剧"、"电影"
- ✅ 内容区域: "热票播报站"、"今日秒杀"

**关键代码**:
```python
# 等待APP启动
time.sleep(3)

# 验证当前页面
current_activity = driver.current_activity
if "MainActivity" in current_activity:
    print("已在首页")

# 关闭弹窗(如果有)
# - 权限弹窗: 点击"下次再说"或"拒绝"
# - 广告弹窗: 点击右上角关闭按钮或坐标(650, 95)
```

**页面状态检测**:
```python
def is_homepage(texts):
    text_str = ''.join(texts)
    has_bottom_nav = ('首页' in text_str and '影院场馆' in text_str and
                      '大麦VIP' in text_str and '发现' in text_str and '我的' in text_str)
    has_category = ('演唱会' in text_str and '话剧音乐剧' in text_str)
    return has_bottom_nav or has_category
```

---

### 步骤3: 切换城市 (可选)

**目标**: 切换到目标城市

**坐标配置**:
```python
coords = {
    "city_selector": (216, 88),      # 城市选择入口
    "city_search_box": (148, 192),   # 城市搜索框
    "city_item": (99, 328),          # 城市选项(第一个)
}
```

**完整流程**:
```python
# 1. 点击城市选择入口
driver.tap([(216, 88)])
time.sleep(1)

# 2. 点击搜索框激活输入
driver.tap([(148, 192)])
time.sleep(0.5)

# 3. 输入城市名称
active_element = driver.switch_to.active_element
active_element.clear()
active_element.send_keys("北京")
time.sleep(1)

# 4. 点击第一个城市选项
driver.tap([(99, 328)])
time.sleep(2)
```

**页面特征** (城市选择页):
- ✅ 标题: "城市选择"
- ✅ "当前定位城市" + "热门城市" + "历史访问城市"
- ✅ 搜索框: "输入城市名或拼音"

---

### 步骤4: 搜索演出

**目标**: 在搜索框输入关键词并搜索

**坐标配置**:
```python
coords = {
    "search_entry": (270, 110),      # 搜索入口(推荐) - learn_complete_flow.py
    # "search_entry": (315, 97),     # 备用坐标 - coordinate_manager.py
}
```

**完整流程**:
```python
# 1. 点击搜索入口 (重要: 不要点击右边的"搜索"按钮!)
driver.tap([(270, 110)])  # 点击搜索框区域
time.sleep(2)

# 2. 验证进入搜索页
current_activity = driver.current_activity
if "Search" in current_activity:
    print("已进入搜索页")

# 3. 查找输入框
input_box = driver.find_element(
    AppiumBy.CLASS_NAME,
    'android.widget.EditText'
)

# 4. 输入关键词
input_box.clear()
input_box.send_keys("2025黎明南京")
time.sleep(2)

# 5. 提交搜索
# 方法1: 点击搜索按钮
search_btn = driver.find_element(
    AppiumBy.ANDROID_UIAUTOMATOR,
    'new UiSelector().text("搜索")'
)
search_btn.click()

# 方法2: 按回车键
driver.press_keycode(66)  # KEYCODE_ENTER

time.sleep(3)
```

**关键要点** (参考`搜索功能修复总结.md`):
- ❌ **错误**: 点击右边的"搜索"按钮 (resource-id: `cn.damai:id/pioneer_homepage_header_search_btn`)
- ✅ **正确**: 点击搜索框区域 (270, 110) 或 (315, 97)
- 原因: 点击搜索框才会进入SearchActivity,显示EditText输入框

**页面特征** (搜索页):
- ✅ "取消"按钮(右上角)
- ✅ EditText输入框激活
- ✅ "全国热搜榜"、"同城玩乐榜"

---

### 步骤5: 选择搜索结果

**目标**: 点击第一个搜索结果进入详情页

**坐标配置**:
```python
coords = {
    "search_result": (155, 195),     # 第一个搜索结果(示例)
}
```

**方法1: 通过文本查找**:
```python
# 查找包含关键词的结果
keyword = "2025黎明南京"
results = driver.find_elements(
    AppiumBy.ANDROID_UIAUTOMATOR,
    f'new UiSelector().textContains("{keyword[:5]}")'
)

if results:
    print(f"找到 {len(results)} 个搜索结果")
    results[0].click()  # 点击第一个
    time.sleep(3)
```

**方法2: 通过坐标点击**:
```python
# 直接点击第一个结果的位置
driver.tap([(155, 195)])
time.sleep(3)
```

**方法3: 通过区域查找可点击元素**:
```python
# 查找屏幕上半部分的可点击元素
clickables = driver.find_elements(
    AppiumBy.ANDROID_UIAUTOMATOR,
    'new UiSelector().clickable(true)'
)

# 筛选y坐标在200-600范围内的
for elem in clickables:
    rect = elem.rect
    if 200 < rect['y'] < 600:
        elem.click()
        break
```

**页面特征** (搜索结果页):
- ✅ 筛选标签: "全部"、"演出"、"电影"、"艺人"
- ✅ 演出列表(封面+标题+时间+地点+价格)

---

### 步骤6: 进入演出详情页

**目标**: 查看演出详情,准备购票

**页面特征** (演出详情页 - 参考截图):
- ✅ 大封面图
- ✅ 演出标题 (如: 【宁波】2025黎明巡回演唱会 - 宁波站)
- ✅ 价格范围: ¥588-1888
- ✅ 演出时间、地点
- ✅ **"立即预订"大按钮** (橙色渐变,底部中央)
- ✅ 标签: "重要通知"、"条件退"、"实名制购票和入场"

**验证代码**:
```python
# 查找"立即预订"按钮
buy_buttons = driver.find_elements(
    AppiumBy.ANDROID_UIAUTOMATOR,
    'new UiSelector().textMatches("立即预订|立即购票|立即购买")'
)

if buy_buttons:
    print(f"已进入详情页,发现{len(buy_buttons)}个购票按钮")
```

**注意事项**:
- 等待3秒确保详情页加载完成
- 可能需要向下滑动查看"立即预订"按钮

---

### 步骤7: 点击立即购票

**目标**: 点击"立即预订"按钮进入场次票档页

**坐标配置**:
```python
coords = {
    "buy_button": (464, 1227),       # 立即购票按钮
}
```

**方法1: 通过文本查找**:
```python
# 查找购票按钮
button_texts = ["立即预订", "立即购票", "立即购买", "选择场次"]
buy_button = None

for text in button_texts:
    try:
        buy_button = driver.find_element(
            AppiumBy.ANDROID_UIAUTOMATOR,
            f'new UiSelector().textContains("{text}")'
        )
        print(f"找到按钮: {text}")
        break
    except:
        continue

if buy_button:
    buy_button.click()
    time.sleep(3)
```

**方法2: 通过坐标点击**:
```python
# 使用固定坐标(可靠性更高)
driver.tap([(464, 1227)])
time.sleep(3)
```

**方法3: 点击底部中央**:
```python
# 获取屏幕尺寸
size = driver.get_window_size()
width = size['width']
height = size['height']

# 点击底部中央位置
bottom_center_x = width // 2
bottom_center_y = height - 100  # 距离底部100像素

driver.tap([(bottom_center_x, bottom_center_y)])
time.sleep(3)
```

**重要提示**:
- ⚠️ **可能出现滑块验证** - 需要人工处理
- ⚠️ 检测滑块: 查找"操作过于频繁"、"请拖动下方滑块还原拼图"
- ⚠️ 处理方式: 暂停自动化,等待人工完成滑块

---

### 步骤8: 选择场次和票档

**目标**: 选择场次、票档,点击确定

**页面特征** (场次票档页 - 参考截图):
- ✅ **橙色背景**顶部区域
- ✅ "场次"标题 + 场次选择框
- ✅ "票档"标题 + 票档选项列表
- ✅ 底部价格显示: ¥0 (未选) 或 ¥1288 (已选)
- ✅ **"确定"按钮** (橙色渐变,底部右侧)

**坐标配置** (示例,不同演出可能不同):
```python
coords = {
    "session_selector": (209, 435),  # 场次选择
    "price_selector": (169, 659),    # 票档选择
    "confirm_button": (558, 1233),   # 确定按钮
}
```

**完整流程**:
```python
# 1. 选择场次
print("选择场次...")
driver.tap([(209, 435)])  # 点击第一个场次
time.sleep(1)

# 2. 选择票档
print("选择票档...")
driver.tap([(169, 659)])  # 点击第一个票档
time.sleep(1)

# 3. 验证是否显示数量选择
# 如果有票,会出现"数量"选择
# 如果缺货,按钮会变成"提交缺货登记"

# 4. 点击确定
print("点击确定...")
driver.tap([(558, 1233)])
time.sleep(2)
```

**智能选择逻辑**:
```python
# 方法1: 通过文本查找场次
sessions = driver.find_elements(
    AppiumBy.ANDROID_UIAUTOMATOR,
    'new UiSelector().text("2025-12-12 周五 19:00")'
)

# 方法2: 选择第一个可点击的场次
session_elements = driver.find_elements(
    AppiumBy.CLASS_NAME,
    'android.widget.TextView'
)
for elem in session_elements:
    text = elem.text
    if '2025' in text and '周' in text:
        elem.click()
        break

# 方法3: 使用OCR识别票档价格,选择最佳
```

**特殊情况处理**:

**情况1: 缺货**
```python
# 检测"提交缺货登记"按钮
out_of_stock_btn = driver.find_elements(
    AppiumBy.ANDROID_UIAUTOMATOR,
    'new UiSelector().text("提交缺货登记")'
)

if out_of_stock_btn:
    print("票已售罄")
    # 选择: 提交缺货登记 或 尝试其他场次/票档
```

**情况2: 数量选择**
```python
# 如果有票,需要选择数量
# 默认是1张,如需多张:
quantity_plus = driver.find_elements(
    AppiumBy.ANDROID_UIAUTOMATOR,
    'new UiSelector().text("+")'
)
if quantity_plus:
    quantity_plus[0].click()  # 增加数量
```

---

### 步骤9: 处理排队/重试

**目标**: 如果遇到排队,快速重试

**检测排队**:
```python
# 查找排队提示
queue_indicators = driver.find_elements(
    AppiumBy.ANDROID_UIAUTOMATOR,
    'new UiSelector().textMatches("当前排队的人数太多|排队中|稍后重试")'
)

if queue_indicators:
    print("检测到排队,开始重试...")
```

**重试逻辑**:
```python
coords = {
    "retry_button": (376, 907)       # 重试按钮
}

max_retries = 200  # 最大重试次数
retry_count = 0

while retry_count < max_retries:
    retry_count += 1

    if retry_count % 10 == 0:
        print(f"已重试 {retry_count}/{max_retries} 次")

    # 快速点击重试按钮
    try:
        driver.tap([(376, 907)])
        time.sleep(0.3)  # 快速重试,间隔0.3秒

        # 检测是否成功进入下一页
        current_activity = driver.current_activity
        if "Order" in current_activity:
            print("成功突破排队!")
            break

    except Exception as e:
        print(f"重试出错: {e}")
        time.sleep(1)
```

**优化策略**:
- 使用最短等待时间(0.1-0.3秒)
- 并发多个请求(需要多个WebDriver实例)
- 监测页面变化,一旦成功立即停止

---

### 步骤10: 提交订单

**目标**: 确认订单信息,完成购票

**页面特征** (订单页):
- ✅ "提交订单"按钮
- ✅ "确认购买"按钮
- ✅ 价格明细
- ✅ 观众信息

**关键代码**:
```python
# 1. 等待订单页加载
time.sleep(3)

# 2. 验证订单页
order_btn = driver.find_elements(
    AppiumBy.ANDROID_UIAUTOMATOR,
    'new UiSelector().textMatches("提交订单|确认购买")'
)

if order_btn:
    print("已进入订单页")

    # 3. 检查订单信息
    # - 验证演出名称、时间、价格
    # - 验证观众信息

    # 4. 提交订单
    print("⚠️ 即将提交订单,请确认!")
    # order_btn[0].click()  # 谨慎操作!
```

**注意事项**:
- ⚠️ **提交订单需谨慎** - 这会真实购票并扣费
- 建议在测试时停在订单确认页,人工完成最后一步
- 记录订单号和购票时间

---

## 完整流程时序图

```
[开始]
  ↓
[1. 连接Appium] → 建立WebDriver连接
  ↓
[2. 等待首页] → 关闭弹窗,确保在首页
  ↓
[3. 切换城市] → (可选) 选择目标城市
  ↓
[4. 搜索演出] → 点击搜索框 → 输入关键词 → 提交搜索
  ↓
[5. 选择结果] → 点击第一个搜索结果
  ↓
[6. 进入详情] → 等待详情页加载
  ↓
[7. 点击购票] → 点击"立即预订"
  ↓  ↓
  ↓  [滑块验证?] → 人工处理 → 继续
  ↓
[8. 选择场次票档] → 选场次 → 选票档 → 点击确定
  ↓  ↓
  ↓  [缺货?] → 提交登记 或 更换场次
  ↓
[9. 处理排队] → (可选) 快速重试200次
  ↓
[10. 提交订单] → 确认信息 → 完成购票
  ↓
[结束]
```

---

## 关键坐标总结

基于实际测试和`coordinate_manager.py`:

```python
# 首页导航
COORDS = {
    # 城市选择
    "city_selector": (216, 88),      # 城市选择入口
    "city_search_box": (148, 192),   # 城市搜索框
    "city_item": (99, 328),          # 第一个城市选项

    # 搜索
    "search_entry": (270, 110),      # 搜索入口(推荐)
    # "search_entry": (315, 97),     # 备用坐标
    "search_result_1": (360, 300),   # 第一个搜索结果

    # 演出选择
    "show_item": (337, 329),         # 演出项
    "buy_button": (464, 1227),       # 立即购票按钮

    # 场次票档(示例,因演出而异)
    "session_1": (209, 435),         # 第一场
    "price_1": (169, 659),           # 第一档
    "price_lowest": (169, 659),      # 最低价
    "confirm_button": (558, 1233),   # 确定按钮

    # 重试
    "retry_button": (376, 907),      # 重试按钮

    # 关闭弹窗
    "close_popup": (650, 95),        # 右上角关闭
}
```

---

## 页面状态检测

基于`page_state_detector.py`和真实截图:

```python
class PageState:
    HOME = "首页"                    # 底部5个导航标签
    CITY_SELECT = "城市选择页"       # "城市选择"标题
    SEARCH = "搜索页"                # "全国热搜榜"
    RESULT = "搜索结果"              # "全部"+"演出"+"电影"标签
    DETAIL = "演出详情"              # "立即预订"大按钮
    SESSION_TICKET = "场次票档页"    # "场次"+"票档"标题
    OUT_OF_STOCK = "缺货登记页"      # "提交缺货登记"按钮
    CAPTCHA = "滑块验证页"           # "操作过于频繁"
    QUEUE_DIALOG = "排队弹窗"        # "当前排队的人数太多"
    ORDER = "订单页"                 # "提交订单"按钮
```

**检测示例**:
```python
from damai_appium import PageStateDetector

detector = PageStateDetector(driver, logger)

# 检测当前页面
state = detector.detect_current_state()
print(f"当前页面: {state}")

# 等待特定页面
if detector.wait_for_state(PageState.DETAIL, timeout=5):
    print("已进入详情页")

# 验证页面状态
if detector.verify_state(PageState.SESSION_TICKET):
    print("确认在场次票档页")
```

---

## 错误处理和重试机制

### 1. 连接重试
```python
max_retries = 3
for attempt in range(max_retries):
    try:
        driver = webdriver.Remote(server_url, options=options)
        break
    except:
        if attempt < max_retries - 1:
            time.sleep(2 ** attempt)  # 指数退避: 1s, 2s, 4s
            continue
        else:
            raise
```

### 2. 元素查找重试
```python
def find_element_safe(locator, timeout=5, max_retries=3):
    for attempt in range(max_retries):
        try:
            element = WebDriverWait(driver, timeout).until(
                EC.presence_of_element_located(locator)
            )
            return element
        except:
            if attempt < max_retries - 1:
                time.sleep(1)
                continue
            return None
```

### 3. 点击重试
```python
def click_safe(coord_name, max_retries=3):
    for attempt in range(max_retries):
        try:
            x, y = coords[coord_name]
            driver.tap([(x, y)])
            time.sleep(2)
            return True
        except:
            if attempt < max_retries - 1:
                time.sleep(1)
                continue
    return False
```

---

## 性能优化

### 1. WebDriver连接复用
```python
# 使用WebDriverManager
from damai_appium import WebDriverManager

manager = WebDriverManager(logger)

# 第1次: 创建连接 (60-140秒)
driver = manager.get_or_create_driver(server_url, capabilities)

# 第2次: 复用连接 (<1秒)
driver = manager.get_or_create_driver(server_url, capabilities)
```

### 2. 智能等待
```python
# 不要使用固定等待
time.sleep(5)  # ❌ 浪费时间

# 使用智能等待
from damai_appium import SmartWait

smart_wait = SmartWait()
smart_wait.wait_for_element(driver, locator, timeout=10)  # ✅ 一旦找到立即返回
```

### 3. 并行处理
```python
# 同时运行多个实例
import threading

def run_bot(instance_id):
    bot = DamaiBot()
    bot.run()

threads = []
for i in range(3):  # 3个并发实例
    t = threading.Thread(target=run_bot, args=(i,))
    t.start()
    threads.append(t)
```

---

## 测试验证

### 单元测试
```bash
# 测试各个模块
pytest tests/unit/

# 测试覆盖率
pytest --cov=damai_appium tests/
```

### 功能测试
```bash
# 测试搜索功能
python test_search_final.py

# 测试完整流程
python test_refactored_bot.py

# 测试WebDriver复用
python test_webdriver_reuse.py
```

### GUI测试
```bash
# 启动重构版GUI
python damai_gui_refactored.py

# 启动智能AI版GUI
python damai_smart_ai.py
```

---

## 常见问题和解决方案

### Q1: 搜索框点击后没反应?
**A**: 不要点击右边的"搜索"按钮,应该点击搜索框区域(270, 110)
- 参考: `搜索功能修复总结.md`

### Q2: 找不到输入框?
**A**: 确保已进入SearchActivity,检查`driver.current_activity`

### Q3: 场次票档坐标不对?
**A**: 每个演出的坐标可能不同,需要:
- 方法1: 截图后手动测量坐标
- 方法2: 使用OCR识别文本位置
- 方法3: 使用`coordinate_manager.py`学习坐标

### Q4: 遇到滑块验证怎么办?
**A**: 检测`PageState.CAPTCHA`,暂停自动化,等待人工处理
```python
if detector.detect_current_state() == PageState.CAPTCHA:
    print("请人工完成滑块验证")
    input("完成后按Enter继续...")
```

### Q5: 排队重试多久合适?
**A**: 建议设置200次重试,间隔0.3秒,总计60秒

---

## 参考资料

### 核心文件
1. `learn_complete_flow.py` - 学习脚本
2. `damai_ticket_bot.py` - 生产版Bot
3. `coordinate_manager.py` - 坐标系统
4. `damai_smart_ai.py` - 智能AI系统
5. `page_state_detector.py` - 页面检测器

### 文档
1. `搜索功能修复总结.md` - 搜索功能修复
2. `WEBDRIVER_PAGE_STATE_FIX.md` - WebDriver和页面状态
3. `页面识别优化_基于真实截图.md` - 页面识别
4. `坐标方案使用指南.md` - 坐标使用

### 截图
- `页面样式/首页.png`
- `页面样式/搜索页.png`
- `页面样式/搜索结果页.png`
- `页面样式/演唱会详情页.png`
- `页面样式/场次选择.png`
- `页面样式/票档选择-有票.png`
- `页面样式/票档选择-缺货.png`
- `页面样式/城市选择页.png`
- `页面样式/滑块页.png`

---

## 总结

**完整抢票流程10步**:
1. ✅ 连接Appium
2. ✅ 等待首页
3. ✅ 切换城市 (可选)
4. ✅ 搜索演出
5. ✅ 选择结果
6. ✅ 进入详情
7. ✅ 点击购票
8. ✅ 选择场次票档
9. ✅ 处理排队 (可选)
10. ✅ 提交订单

**关键成功因素**:
- ✅ 使用正确的坐标点击
- ✅ 实时监控页面状态
- ✅ 快速处理弹窗和验证
- ✅ 合理的重试机制
- ✅ WebDriver连接复用

---

**学习完成时间**: 2025-11-16
**学习人**: Claude Code
**版本**: v3.0.3 (完整流程学习版)
