# 完整抢票流程测试指南

## 测试准备

### 环境检查 ✅
- ADB设备: 127.0.0.1:62616 ✅ 已连接
- Appium服务: http://127.0.0.1:4723 ✅ 运行中
- 配置文件: damai_appium/config.jsonc ✅ 已配置

### 当前配置
```json
{
  "server_url": "http://127.0.0.1:4723",
  "adb_port": "62616",
  "keyword": "乌龙山伯爵",
  "city": "北京",
  "date": "11.2",
  "price": "50"
}
```

---

## 🎯 测试流程 (12步)

### 准备工作
1. 确保大麦App已安装并在首页
2. 确保设备网络正常
3. 确保模拟器/设备屏幕亮着

### 启动测试

**方法1: GUI测试(推荐)**
```bash
python damai_smart_ai.py
```

**操作步骤**:
1. 点击"连接设备"按钮
2. 等待连接成功
3. 填写参数:
   - 城市: 北京 (或你想测试的城市)
   - 演出名称: 乌龙山伯爵 (或实际演出名)
   - 关键词: 乌龙山伯爵
4. 点击"开始抢票"按钮
5. 观察GUI日志输出

**方法2: 命令行测试**
```bash
python damai_ticket_bot.py --city 北京 --keyword "乌龙山伯爵"
```

---

## 📝 测试检查清单

### 步骤0: 检查App运行状态
- [ ] App已启动
- [ ] 显示首页
- [ ] 无弹窗干扰

### 步骤1: 处理弹窗
- [ ] 自动关闭升级弹窗
- [ ] 自动关闭权限弹窗
- [ ] 自动关闭广告弹窗

### 步骤2: 切换城市 (4步)
- [ ] 点击城市选择入口 (216, 88)
- [ ] 点击搜索框激活 (148, 192) ⚠️ 关键!
- [ ] 成功输入中文城市名
- [ ] 点击城市选项 (99, 328)
- [ ] 城市切换成功

### 步骤3-4: 搜索演出
- [ ] 点击搜索入口 (315, 97)
- [ ] 成功输入关键词
- [ ] 显示搜索结果

### 步骤5: 点击搜索结果
- [ ] 点击第一个搜索结果 (155, 195)
- [ ] 进入演出列表页或详情页

### 步骤6-8: 选择演出
- [ ] 点击目标演出 (337, 329)
- [ ] 等待详情页加载
- [ ] 显示演出信息

### 步骤9: 点击立即购票
- [ ] 点击购票按钮 (464, 1227)
- [ ] 等待页面跳转
- [ ] 是否出现滑块验证?
  - [ ] 是 → 手动完成滑块 (等待5秒)
  - [ ] 否 → 继续

### 步骤10: 选择场次/票档 (3步) ⭐ 新增测试
- [ ] 选择场次 (209, 435)
- [ ] 选择票档 (169, 659)
- [ ] 点击确认 (558, 1233)

⚠️ **重要**: 这些坐标因演出而异,如果点击位置不对:
1. 使用ADB手动测试坐标:
   ```bash
   adb shell input tap 209 435  # 测试场次坐标
   adb shell input tap 169 659  # 测试票档坐标
   adb shell input tap 558 1233 # 测试确认坐标
   ```
2. 如不准确,记录正确坐标备用

### 步骤11: 排队重试 (可选)
- [ ] 检查是否需要排队
- [ ] 如需要,是否自动重试

### 步骤12: 保存截图
- [ ] 截图已保存
- [ ] 文件名格式: `grab_ticket_YYYYMMDD_HHMMSS.png`

---

## 🔍 重点测试项

### 1. 城市切换 (最容易出问题)
**测试要点**:
- 搜索框是否成功激活 (148, 192)
- 中文输入是否正常
- 城市是否正确切换

**如何验证**:
- 观察GUI日志: `[步骤2/4] 点击搜索框激活 (关键!)`
- 观察日志: `✓ 成功输入城市名: XXX (Appium方式)`

### 2. 场次/票档选择 (新增功能)
**测试要点**:
- 坐标是否准确
- 3步流程是否完整执行
- 是否成功进入下一步

**如何验证**:
- 观察GUI日志: `[步骤10] 选择场次和票档`
- 观察日志: `[步骤1/3] 选择场次 (209, 435)`
- 观察日志: `[步骤2/3] 选择票档 (169, 659)`
- 观察日志: `[步骤3/3] 点击确认按钮 (558, 1233)`
- 观察日志: `✓ 场次和票档选择完成!`

### 3. 滑块验证
**测试要点**:
- 是否检测到滑块
- 是否给用户足够时间处理

**如何验证**:
- 观察GUI日志: `提示: 如果出现滑块验证,请手动完成`
- 检查是否有5秒等待时间

---

## ⚠️ 常见问题和解决方案

### 问题1: 城市切换失败
**现象**: 没有输入城市名,或输入失败

**原因**: 搜索框未激活

**解决**:
1. 检查坐标 (148, 192) 是否准确
2. 手动测试: `adb shell input tap 148 192`
3. 观察是否弹出键盘

### 问题2: 场次/票档点击位置不对
**现象**: 点击了错误的位置

**原因**: 不同演出布局不同

**解决**:
1. 手动进入该演出的场次/票档页面
2. 使用ADB测试坐标:
   ```bash
   adb shell input tap X Y
   ```
3. 找到正确坐标后记录
4. 后续可以在GUI中自定义坐标

### 问题3: 搜索结果页不对
**现象**: 点击搜索结果后进入错误页面

**原因**: 搜索结果坐标不准

**解决**:
1. 检查坐标 (155, 195)
2. 手动测试并调整

### 问题4: 滑块验证卡住
**现象**: 出现滑块后流程停滞

**原因**: 当前版本需要手动处理滑块

**解决**:
1. 在GUI提示后手动完成滑块
2. 等待5秒让流程继续

---

## 📊 测试报告模板

```
# 抢票流程测试报告

测试时间: ____年__月__日 __:__
测试人员: ________
测试演出: ________
测试城市: ________

## 测试结果

| 步骤 | 状态 | 备注 |
|------|------|------|
| 0. 检查App | ⃣ | |
| 1. 处理弹窗 | ⃣ | |
| 2. 切换城市 | ⃣ | |
| 3-4. 搜索演出 | ⃣ | |
| 5. 点击结果 | ⃣ | |
| 6-8. 选择演出 | ⃣ | |
| 9. 点击购票 | ⃣ | |
| 10. 选择场次/票档 | ⃣ | 坐标是否准确? |
| 11. 排队重试 | ⃣ | 是否触发? |
| 12. 保存截图 | ⃣ | |

## 发现的问题

1.
2.
3.

## 建议改进

1.
2.
3.

## 总体评价

成功率: ___%
平均耗时: ____秒
```

---

## 🎯 测试目标

### 功能性测试
- [ ] 完整流程可以走通
- [ ] 所有11个坐标都正常工作
- [ ] 中文输入正常
- [ ] 日志输出完整

### 健壮性测试
- [ ] 失败后可以重试
- [ ] 异常情况有提示
- [ ] 不会崩溃退出

### 性能测试
- [ ] 记录完整流程耗时
- [ ] 每个步骤的耗时
- [ ] 重试次数统计

---

## 💡 测试建议

### 第一次测试 (基础验证)
1. 使用配置文件中的演出 (乌龙山伯爵)
2. 完整走一遍流程
3. 记录每步的执行情况
4. 截图保存关键步骤

### 第二次测试 (坐标校准)
1. 针对实际要抢的演出
2. 手动进入场次/票档页面
3. 测试并记录正确坐标:
   ```bash
   # 测试场次坐标
   adb shell input tap 209 435

   # 测试票档坐标
   adb shell input tap 169 659

   # 测试确认坐标
   adb shell input tap 558 1233
   ```
4. 更新配置或记录备用

### 第三次测试 (完整演练)
1. 使用校准后的坐标
2. 模拟真实抢票场景
3. 测试排队重试功能
4. 评估成功率

---

## 📞 问题反馈

如遇到问题,请记录以下信息:
1. 完整的GUI日志输出
2. 失败时的截图
3. 当前步骤和错误信息
4. 设备/模拟器信息
5. 配置文件内容

---

## ✅ 预期成功标准

1. **完整性**: 12个步骤全部执行
2. **准确性**: 坐标点击位置正确
3. **稳定性**: 多次测试结果一致
4. **日志**: 每步都有清晰记录
5. **截图**: 自动保存最终状态

---

**祝测试顺利!** 🎉

如有任何问题,请参考:
- `GUI优化总结.md` - 优化详情
- `项目优化建议.md` - 进一步改进建议
- `TICKET_FLOW_COORDS.md` - 完整坐标说明
