# 大麦抢票机器人 - 使用指南

## 概述

`damai_ticket_bot.py` 是基于实际测试优化的生产级抢票脚本,包含完整的错误处理和重试机制。

## 核心特性

### ✅ 已实现功能

1. **完整抢票流程**
   - 自动等待首页加载
   - 智能城市切换
   - 关键词搜索演出
   - 自动选择演出
   - 一键购票
   - 场次/票档选择
   - 排队重试机制(可选)

2. **健壮性增强**
   - 自动重试失败的点击操作(默认3次)
   - 页面状态验证
   - WebDriver异常处理
   - 超时保护机制
   - 详细的日志输出

3. **中文支持**
   - 使用Appium的send_keys方法支持中文输入
   - 城市名称、搜索关键词完美支持中文

4. **灵活配置**
   - JSON配置文件
   - 命令行参数覆盖
   - 可自定义坐标
   - 可调整重试次数和等待时间

---

## 快速开始

### 1. 准备工作

**环境要求:**
- Python 3.7+
- Appium Server 运行中 (http://127.0.0.1:4723)
- Android模拟器/真机 (已安装大麦App)
- ADB连接正常

**检查环境:**
```bash
# 检查Appium服务
curl http://127.0.0.1:4723/status

# 检查ADB设备
adb devices

# 检查Python依赖
pip install appium-python-client selenium
```

### 2. 配置文件

编辑 `damai_appium/config.jsonc`:

```json
{
  "server_url": "http://127.0.0.1:4723",
  "adb_port": "62616",              // 你的设备端口
  "keyword": "2025黎明巡回演唱会",   // 搜索关键词
  "city": "南京",                    // 目标城市
  "date": "11.2",
  "price": "50",
  "price_index": 2,
  "if_commit_order": true
}
```

### 3. 基础使用

**最简单的用法 (使用配置文件):**
```bash
python damai_ticket_bot.py
```

**指定城市和关键词:**
```bash
python damai_ticket_bot.py --city 北京 --keyword "张学友演唱会"
```

**启用排队重试:**
```bash
python damai_ticket_bot.py --queue-retry
```

**自定义重试次数:**
```bash
python damai_ticket_bot.py --queue-retry --max-queue-retries 500
```

---

## 高级用法

### 命令行参数完整列表

```bash
python damai_ticket_bot.py \
    --config damai_appium/config.jsonc \  # 配置文件路径
    --city 南京 \                          # 目标城市
    --keyword "2025黎明巡回演唱会" \       # 搜索关键词
    --queue-retry \                        # 启用排队重试
    --max-queue-retries 300                # 最大重试次数
```

### 自定义坐标

如果默认坐标不适合你的设备,可以在代码中修改:

```python
bot = DamaiTicketBot()

# 更新特定坐标
bot.update_coords("city_selector", 216, 88)
bot.update_coords("search_entry", 315, 97)

# 运行
bot.run()
```

### 坐标配置说明

当前脚本包含以下坐标(基于实际测试):

| 坐标名称 | 默认值 | 说明 |
|---------|-------|------|
| city_selector | (216, 88) | 城市选择入口 |
| city_search_box | (148, 192) | 城市搜索框激活 ⚠️ |
| city_item | (99, 328) | 城市列表项 |
| search_entry | (315, 97) | 首页搜索入口 |
| search_result | (155, 195) | 搜索结果 |
| show_item | (337, 329) | 演出列表项 |
| buy_button | (464, 1227) | 立即购票按钮 |
| session_selector | (209, 435) | 场次选择 ⚠️ |
| price_selector | (169, 659) | 票档选择 ⚠️ |
| confirm_button | (558, 1233) | 确定按钮 |
| retry_button | (376, 907) | 排队重试按钮 |

**⚠️ 注意:**
- `city_search_box`: 必须先点击才能激活输入框
- `session_selector`, `price_selector`: 不同演出的页面布局可能不同,需要根据实际情况调整

---

## 重要提示

### 1. 城市选择流程

城市选择需要**4个步骤**,缺一不可:
```
点击城市入口 → 点击搜索框激活 → 输入城市名 → 点击城市项
(216, 88)   → (148, 192)      → send_keys → (99, 328)
```

**常见错误:** 忘记点击搜索框激活,直接输入会失败

### 2. 中文输入

所有中文输入都使用Appium的 `send_keys()` 方法:
```python
active = driver.switch_to.active_element
active.send_keys("南京")  # ✅ 正确
```

**不要使用:**
```bash
adb shell input text "nanjing"  # ❌ 只支持英文
```

### 3. 场次/票档坐标

⚠️ **最重要的注意事项:**

场次和票档页面的坐标**因演出而异**!

**使用前必须:**
1. 手动进入目标演出的场次/票档页面
2. 使用 `adb shell input tap X Y` 测试正确的坐标
3. 更新脚本中的坐标配置

**推荐做法:**
```bash
# 1. 进入场次页面后,截图并获取坐标
adb shell screencap /sdcard/session_page.png
adb pull /sdcard/session_page.png

# 2. 测试坐标是否准确
adb shell input tap 209 435  # 测试场次坐标
adb shell input tap 169 659  # 测试票档坐标
adb shell input tap 558 1233 # 测试确认按钮
```

### 4. 滑块验证

点击"立即购票"后,**可能**出现滑块验证。

**当前处理方式:**
- 脚本会暂停2秒,提示需要手动处理
- 你需要在2秒内手动完成滑块验证
- 或者集成自动滑块识别(TODO)

### 5. 排队重试

排队重试会快速连续点击"重试"按钮。

**建议配置:**
- 热门演出: `--max-queue-retries 500`
- 普通演出: `--max-queue-retries 200`
- 测试: `--max-queue-retries 10`

---

## 日志说明

脚本使用emoji图标标识不同级别的日志:

| 图标 | 级别 | 说明 |
|-----|------|------|
| ℹ️ | INFO | 常规信息 |
| ✅ | SUCCESS | 操作成功 |
| ❌ | ERROR | 错误,可能需要人工介入 |
| ⚠️ | WARNING | 警告,继续执行但需注意 |
| 📍 | STEP | 流程步骤标记 |
| 🔄 | RETRY | 重试操作 |
| 🔍 | DEBUG | 调试信息 |

**示例输出:**
```
14:32:10 📍 [步骤] 大麦抢票机器人启动
14:32:10 ℹ️  [信息] 正在连接设备...
14:32:12 ✅ [成功] 设备连接成功: 127.0.0.1:62616
14:32:12 📍 [步骤] 等待首页加载...
14:32:22 ✅ [成功] 首页加载完成
14:32:22 📍 [步骤] 开始切换城市到: 南京
14:32:22 ℹ️  [信息] 点击坐标: city_selector (216, 88)
...
```

---

## 故障排查

### 问题1: 点击失败

**症状:** 日志显示 `点击 XXX 最终失败`

**可能原因:**
- 页面未加载完成
- 坐标不准确
- 网络延迟

**解决方案:**
```python
# 增加等待时间
bot.retry_config['click_wait'] = 3  # 默认2秒

# 增加重试次数
bot.retry_config['max_click_retries'] = 5  # 默认3次
```

### 问题2: 中文输入失败

**症状:** 输入框显示乱码或为空

**解决方案:**
- 确保使用 `send_keys()` 而非ADB命令
- 确保点击了输入框激活
- 检查Appium服务是否正常

### 问题3: 城市切换失败

**症状:** 城市未切换或选择了错误的城市

**检查清单:**
1. 是否点击了搜索框激活 (148, 192)
2. 中文输入是否成功
3. 城市列表项坐标是否正确

### 问题4: 场次/票档选择失败

**症状:** 点击后未选中目标场次或票档

**原因:** 不同演出的页面布局不同

**解决方案:**
1. 手动进入目标演出的场次页面
2. 截图或使用开发者工具获取准确坐标
3. 更新脚本中的坐标配置

---

## 最佳实践

### 1. 提前测试

正式抢票前,务必完整测试一遍流程:

```bash
# 测试脚本(不启用排队重试)
python damai_ticket_bot.py --city 南京 --keyword "测试演出"
```

**检查清单:**
- ✅ 城市切换成功
- ✅ 搜索功能正常
- ✅ 演出选择准确
- ✅ 场次/票档坐标正确
- ✅ 购票按钮可点击

### 2. 坐标校准

为目标演出创建专用坐标配置:

```python
# 为特定演出优化坐标
show_coords = {
    "session_selector": (209, 435),  # 根据实际调整
    "price_selector": (169, 659),    # 根据实际调整
    "confirm_button": (558, 1233)    # 根据实际调整
}

bot.coords.update(show_coords)
```

### 3. 日志记录

重定向日志到文件,便于分析:

```bash
python damai_ticket_bot.py --queue-retry 2>&1 | tee ticket_log.txt
```

### 4. 多设备并行

使用多个模拟器/设备提高成功率:

```bash
# 设备1 (端口62616)
python damai_ticket_bot.py --config config1.jsonc &

# 设备2 (端口62617)
python damai_ticket_bot.py --config config2.jsonc &
```

---

## 性能优化

### 减少等待时间

适当减少等待时间提高速度(但可能降低稳定性):

```python
bot.retry_config['click_wait'] = 1  # 从2秒减到1秒
```

### 快速重试模式

排队重试时使用更短的间隔:

```python
# 在 handle_queue_retry 方法中
time.sleep(0.1)  # 从0.3秒减到0.1秒
```

⚠️ **风险:** 过快的请求可能被服务器限流

---

## 脚本对比

| 特性 | test_ticket_flow.py | damai_ticket_bot.py |
|-----|-------------------|-------------------|
| 用途 | 学习/测试 | 生产使用 |
| 错误处理 | 基础 | 完善 |
| 重试机制 | 无 | 有 |
| 日志 | 简单 | 详细(emoji) |
| 配置方式 | 硬编码 | JSON + 命令行 |
| 中文支持 | 部分 | 完整 |
| 代码行数 | 340 | 550+ |
| 推荐场景 | 调试坐标 | 正式抢票 |

---

## 常见问题 FAQ

**Q: 为什么要点击两次城市选择?**
A: 第一次点击(216, 88)打开城市页面,第二次点击(148, 192)激活搜索输入框。这是实际测试发现的必要步骤。

**Q: 坐标在我的设备上不准确怎么办?**
A: 不同分辨率的设备坐标不同。请使用 `adb shell input tap X Y` 测试并更新坐标。

**Q: 脚本支持选座吗?**
A: 当前版本使用固定坐标点击,不支持智能选座。如需选座,需要根据座位图开发OCR识别或坐标映射逻辑。

**Q: 如何处理实名认证?**
A: 脚本不处理实名认证。请确保App已完成实名认证并登录。

**Q: 排队重试有用吗?**
A: 有用,但效果取决于演出热度。热门演出可能需要重试数百次。

**Q: 脚本会自动提交订单吗?**
A: 当前版本不会自动提交订单,需要人工确认。可以通过修改代码实现,但需谨慎测试。

---

## 版本历史

### v1.0 (2025-11-15)
- ✅ 完整抢票流程实现
- ✅ 基于实际测试的坐标
- ✅ 中文输入支持
- ✅ 错误处理和重试机制
- ✅ 详细日志输出
- ✅ JSON配置文件
- ✅ 命令行参数

### 待开发功能 (TODO)
- [ ] 自动滑块验证识别
- [ ] 智能选座功能
- [ ] 多账号并发
- [ ] 订单自动提交
- [ ] 页面元素智能识别(替代固定坐标)
- [ ] 定时抢票功能
- [ ] 微信/邮件通知

---

## 技术支持

遇到问题请提供:
1. 完整的错误日志
2. 设备信息 (adb devices 输出)
3. 配置文件内容
4. 截图(如有)

---

## 免责声明

本脚本仅供学习研究使用,使用者需遵守大麦平台的用户协议。
因使用本脚本导致的任何后果,作者不承担责任。

---

生成时间: 2025-11-15
作者: Claude Code
