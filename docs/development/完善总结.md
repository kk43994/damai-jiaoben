# 大麦抢票 - 完善总结 (2025-11-15)

## 一、今日完成的主要工作

### 1. **手动教学完整抢票流程** ✅

通过实际操作,学习并记录了完整的7步抢票流程:

1. 等待首页加载
2. 切换城市 (4个子步骤)
   - 点击城市选择入口 (216, 88)
   - **点击搜索框激活** (148, 192) ⚠️ 关键步骤
   - 输入城市名称(中文)
   - 点击城市选项 (99, 328)
3. 搜索演出
   - 点击搜索入口 (315, 97)
   - 输入关键词
   - 点击搜索结果 (155, 195)
4. 选择演出 (337, 329)
5. 立即购票 (464, 1227)
   - 可能出现滑块验证(需手动处理)
6. 选择场次和票档
   - 选择场次 (209, 435) ⚠️ 因演出而异
   - 选择票档 (169, 659) ⚠️ 因演出而异
   - 确认 (558, 1233)
7. 排队重试 (376, 907) - 可选

### 2. **创建生产级抢票脚本** ✅

**文件**: `damai_ticket_bot.py` (550+ 行)

**核心特性**:
- ✅ 完整的错误处理和重试机制
- ✅ 中文输入支持(使用Appium send_keys)
- ✅ 页面状态验证
- ✅ 可配置的坐标和参数
- ✅ 详细的日志输出(带emoji标识)
- ✅ 命令行参数支持
- ✅ JSON配置文件
- ✅ 自动重试(默认3次)
- ✅ 排队重试机制(可自定义次数)

**使用示例**:
```bash
# 基础使用
python damai_ticket_bot.py

# 自定义参数
python damai_ticket_bot.py --city 南京 --keyword "2025黎明巡回演唱会"

# 启用排队重试
python damai_ticket_bot.py --queue-retry --max-queue-retries 300
```

### 3. **创建详细使用文档** ✅

**文件**: `USAGE_GUIDE.md`

**包含内容**:
- 快速开始指南
- 命令行参数说明
- 坐标配置详解
- 重要注意事项
  - 城市选择4步流程
  - 中文输入方法
  - 场次/票档坐标因演出而异
  - 滑块验证处理
- 故障排查
- 最佳实践
- FAQ常见问题

### 4. **创建流程文档** ✅

**文件**: `TICKET_FLOW_COORDS.md`

**包含内容**:
- 完整7步流程说明
- 所有坐标速查表
- 注意事项
- 实现建议
- 测试建议

### 5. **创建测试脚本** ✅

**文件**: `test_ticket_flow.py` (340行)

用于测试和调试各个步骤的坐标是否准确。

### 6. **创建GUI集成脚本** ✅

**文件**: `damai_gui.py`

- 图形化界面
- 参数输入框(ADB端口、城市、关键词)
- 排队重试选项
- 实时日志显示
- 状态指示

---

## 二、关键发现和学习

### 1. 城市选择需要4个步骤
之前以为只需3步,实际需要:
1. 点击城市入口
2. **点击搜索框激活** (新发现!)
3. 输入城市
4. 选择城市

### 2. 中文输入必须使用Appium
ADB命令 `adb shell input text` 不支持中文,必须使用:
```python
active = driver.switch_to.active_element
active.send_keys("南京")  # 正确方法
```

### 3. 场次/票档坐标因演出而异
不同演出的场次/票档页面布局不同,坐标需要根据实际演出调整。

### 4. 滑块验证可能出现
点击"立即购票"后可能出现滑块验证,当前需要手动处理。

---

## 三、文件结构

```
ticket-purchase/
├── damai_ticket_bot.py      # 主抢票脚本(生产级)
├── damai_gui.py              # GUI界面集成
├── test_ticket_flow.py       # 测试脚本
├── USAGE_GUIDE.md            # 使用指南
├── TICKET_FLOW_COORDS.md     # 流程坐标文档
├── input_chinese.py          # 中文输入测试
├── damai_appium/
│   ├── config.jsonc          # 配置文件
│   └── ...
└── ...
```

---

## 四、下一步建议

### 1. 集成到现有GUI

**目标**: 将 `damai_ticket_bot.py` 集成到现有的 `damai_smart_ai.py` GUI中

**方法**:
1. 在GUI中添加"一键抢票"按钮
2. 添加城市和关键词输入框
3. 调用 `DamaiTicketBot` 类执行抢票流程
4. 将日志输出到GUI的日志框

**示例代码**:
```python
# 在damai_smart_ai.py中添加
from damai_ticket_bot import DamaiTicketBot

def start_auto_ticket():
    """一键抢票"""
    bot = DamaiTicketBot()
    bot.config['city'] = city_entry.get()
    bot.config['keyword'] = keyword_entry.get()

    # 重定向日志到GUI
    def gui_log(message, level="INFO"):
        log_to_gui(message, level)
    bot.log = gui_log

    # 在新线程中运行
    thread = threading.Thread(target=bot.run, daemon=True)
    thread.start()
```

### 2. 坐标校准工具

创建一个GUI工具,用于:
- 显示当前截图
- 点击截图获取坐标
- 保存坐标配置

### 3. 自动滑块识别

集成滑块验证自动识别(可选):
- 使用OCR识别滑块位置
- 计算滑动距离
- 模拟滑动操作

### 4. 定时抢票

添加定时功能:
- 设置开抢时间
- 倒计时显示
- 到时自动执行

### 5. 多账号并发

支持多个账号同时抢票:
- 多个ADB端口
- 多个配置文件
- 并发执行

---

## 五、使用建议

### 正式抢票前必做:

1. **测试完整流程**
   ```bash
   python damai_ticket_bot.py --city 测试城市 --keyword "测试演出"
   ```

2. **校准场次/票档坐标**
   - 手动进入目标演出的场次页面
   - 使用 `adb shell input tap X Y` 测试坐标
   - 更新脚本中的坐标配置

3. **准备滑块验证方案**
   - 提前练习手动滑块验证
   - 或准备自动识别方案

4. **检查环境**
   ```bash
   # 检查Appium服务
   curl http://127.0.0.1:4723/status

   # 检查ADB连接
   adb devices
   ```

### 抢票时建议:

1. **提前5分钟启动脚本**
   - 确保首页已加载
   - 城市已切换
   - 演出详情页已打开

2. **使用排队重试**
   ```bash
   python damai_ticket_bot.py --queue-retry --max-queue-retries 500
   ```

3. **多设备并行**
   - 使用多个模拟器/设备
   - 每个设备运行一个脚本实例

4. **监控日志**
   ```bash
   python damai_ticket_bot.py --queue-retry 2>&1 | tee log.txt
   ```

---

## 六、技术亮点

### 1. 健壮的错误处理
```python
def click_coord(self, coord_name, max_retries=3):
    for attempt in range(max_retries):
        try:
            self.driver.tap([(x, y)])
            return True
        except WebDriverException as e:
            if attempt < max_retries - 1:
                time.sleep(1)
                continue
            return False
```

### 2. 中文输入支持
```python
def input_text(self, text):
    active = self.driver.switch_to.active_element
    active.clear()
    active.send_keys(text)  # 完美支持中文
```

### 3. 页面状态验证
```python
def verify_page_state(self, expected_activity=None):
    current_activity = self.driver.current_activity
    return expected_activity in current_activity
```

### 4. 灵活的配置系统
- JSON配置文件
- 命令行参数覆盖
- 运行时动态更新

---

## 七、已知限制

1. **坐标固定**
   - 当前使用固定坐标,不同分辨率设备需要调整
   - 未来可考虑元素识别(文字/图像识别)

2. **滑块验证**
   - 当前需手动处理
   - 未来可集成自动识别

3. **场次/票档布局**
   - 不同演出布局不同
   - 需要为每个演出单独配置坐标

4. **订单提交**
   - 当前不自动提交订单
   - 需要人工确认

---

## 八、总结

今天完成了从**手动教学**到**生产级脚本**的完整开发:

1. ✅ 学习并记录了完整流程
2. ✅ 发现并解决了关键问题(搜索框激活、中文输入)
3. ✅ 创建了健壮的抢票脚本
4. ✅ 编写了详细的使用文档
5. ✅ 提供了测试和GUI集成方案

**下一步**: 将抢票脚本集成到现有的 `damai_smart_ai.py` GUI中,实现一键抢票功能!

---

生成时间: 2025-11-15
作者: Claude Code
