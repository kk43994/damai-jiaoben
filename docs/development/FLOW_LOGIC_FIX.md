# 抢票流程逻辑修复总结

## 问题描述
用户反馈页面检测逻辑有问题:
1. 搜索页被误判为首页
2. 流程过于复杂,有太多不必要的验证

## 正确的抢票流程 (用户确认)

### 流程步骤:

1. **启动大麦APP**
   - 等待5秒后**直接认为进入首页**
   - ❌ 不需要Activity验证
   - ❌ 不需要页面状态验证

2. **首页 - 处理弹窗**
   - 检查是否有弹窗关键词
   - 有弹窗 → 关闭
   - 无弹窗 → 直接下一步

3. **首页 - 点击城市选择器** → 点击(216,88)
   - 进入城市选择页

4. **城市选择页 - 点击城市搜索** → 点击(99,238)
   - **注意**: 坐标是(99,238)不是(99,328)

5. **城市选择页 - 输入城市关键词** (如"南京")

6. **城市选择页 - 点击城市** → 选择城市
   - 返回首页(已切换城市)

7. **首页 - 点击搜索框** → 点击(315,97)
   - 进入搜索页

8. **搜索页 - 输入关键词** (如"2025黎明巡回演唱会")

9. **搜索页 - 点击搜索结果** → 点击(155,195)
   - 进入演出列表页

10. **演出列表页 - 点击演出** → 点击(337,329)
    - 进入演出详情页

11. **演出详情页 - 点击立即购票** → 点击(464,1227)
    - 进入场次/票档页

12. **场次票档页 - 选择场次** → 点击(209,435)

13. **场次票档页 - 选择票档** → 点击(169,659)

14. **场次票档页 - 确定** → 点击(558,1233)
    - 提交选择

15. **如果遇到"排队人数太多"提示** → 疯狂点击(376,907)重试

## 页面状态定义

### 新增页面状态:
- `CITY_SELECT` - 城市选择页
- `SESSION_TICKET` - 场次票档页

### 页面特征:

| 页面 | 关键特征 | 优先级 |
|------|---------|--------|
| 弹窗 | 立即开启、下次再说、位置权限 | 1 |
| 错误页 | 网络异常、加载失败 | 2 |
| 加载中 | 加载中、loading | 3 |
| 订单页 | 提交订单、确认购买 | 4 |
| **场次票档页** | 场次+票档、选择场次、排队中 | 5 |
| 详情页 | 立即购票、立即购买、演出详情 | 6 |
| **城市选择页** | 当前定位、热门城市、切换城市 | 7 |
| 搜索页 | 输入框被激活、搜索演出、历史搜索 | 8 |
| 演出列表页 | 有场次信息 且 无购买按钮 且 无票档 | 9 |
| 首页 | 底部导航栏(首页+发现+我的) 且 无其他强特征 | 10 |
| 搜索结果页 | 搜索结果 | 11 |
| 选座页 | 请先选座、选座购买 | 12 |

## 关键修复点

### 1. 启动流程简化 (damai_smart_ai.py:1967-2011)

**修复前**:
```python
# 复杂的验证流程
- 检查App状态
- 等待2秒
- 验证页面状态
- 多次重试确认首页
- 恢复页面状态
- 强制返回首页
```

**修复后**:
```python
# 简化流程
- 检查App运行
- 等待5秒 ✅ 直接认为进入首页
- 检查弹窗,有则关闭
```

### 2. 页面检测逻辑优化 (damai_smart_ai.py:375-486)

**关键改进**:
1. ✅ 新增城市选择页检测
2. ✅ 新增场次票档页检测
3. ✅ 搜索页强特征判断(输入框激活、搜索演出文字)
4. ✅ 首页判断加强(排除其他页面强特征)
5. ✅ 列表页与票档页区分(检查"票档"关键词)

### 3. 城市切换流程确认 ✅

**完整流程**:
1. 首页 → 点击(216, 88) → 进入城市选择页
2. 城市选择页 → 点击(148, 192)激活搜索框
3. 输入城市关键词 (如"南京")
4. 点击(99, 328) → **确认城市选择并返回首页**

**关键坐标**:
- `CITY_SELECTOR_COORD = (216, 88)` - 城市选择入口
- `CITY_SEARCH_BOX_COORD = (148, 192)` - 搜索框激活
- `CITY_ITEM_COORD = (99, 328)` - 确认城市选择并返回首页 ✅

## 待办事项

- [ ] 重新启动GUI测试修复效果
- [ ] 确认城市选择的坐标 (99,238) vs (99,328)
- [ ] 测试完整抢票流程
- [ ] 验证页面状态识别准确性

---
**修复时间**: 2025-11-15
**状态**: 进行中
