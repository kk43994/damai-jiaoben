# 连接自动修复功能说明

## 更新内容

已为 Smart GUI (`damai_smart_ai.py`) 和重构版GUI (`damai_gui_refactored.py`) 添加了强大的**连接自动检测和修复功能**。

## 功能特性

### 1. 自动检测连接状态
- **Appium 服务检测**：自动检查 Appium 服务是否运行
- **ADB 设备检测**：自动检查 ADB 设备是否连接
- **端口自动扫描**：如果指定端口连接失败，自动扫描常用端口

### 2. 一键自动修复
- **自动启动 Appium**：如果 Appium 未运行，自动启动服务
- **自动连接 ADB**：如果设备未连接，自动执行 `adb connect`
- **智能端口切换**：如果当前端口不可用，自动扫描并连接可用端口

### 3. 支持的端口范围
自动扫描以下常用端口：
- **红手指**: 59700, 59701, 59702, 53709, 52880
- **MuMu模拟器**: 16384, 16416, 16448
- **夜神模拟器**: 62001, 62025, 62026
- **雷电模拟器**: 5555, 5557, 5559

## 使用方法

### Smart GUI (主要使用)

#### 方法1: 手动输入端口后连接（推荐）
1. 启动 `damai_smart_ai.py`
2. 在 **"ADB端口"** 输入框中输入您的端口号（如 `52880`）
3. 点击 **"连接设备"** 按钮
4. 系统会自动：
   - 检查并启动 Appium 服务
   - 检查并连接 ADB 设备
   - 如果失败，自动扫描其他可用端口
   - 创建 WebDriver 连接

#### 方法2: 自动检测端口
1. 确保红手指已启动并连接 ADB
2. 点击 **"自动检测"** 按钮
3. 系统会自动检测当前已连接的 ADB 设备端口
4. 点击 **"连接设备"** 执行自动修复流程

#### 方法3: 一键环境修复
1. 点击 **"🔨 一键修复"** 按钮
2. 系统会自动：
   - 扫描并连接 ADB 设备
   - 启动 Appium 服务
   - 更新配置文件
3. 修复完成后点击 **"连接设备"**

### 重构版 GUI

#### 启动抢票时自动检测
1. 启动 `damai_gui_refactored.py`
2. 输入 ADB 端口（如 `52880`）
3. 配置抢票参数
4. 点击 **"开始抢票"**
5. 系统会在启动前自动检测和修复连接
6. 如果检测到问题，会弹出提示询问是否自动修复

#### 手动检测和修复
1. 点击 **"检测WebDriver"** 按钮
2. 系统会检测当前连接状态并尝试修复

## 日志说明

### 正常流程日志
```
============================================================
[自动连接修复] 开始检测和修复连接状态
============================================================
[1/2] 检测Appium服务...
✓ Appium服务运行正常
[2/2] 检测ADB设备连接...
✓ ADB设备已连接: 127.0.0.1:52880
============================================================
✓ 所有连接检测通过，可以开始抢票
============================================================
```

### 自动修复流程日志
```
============================================================
开始自动修复连接
============================================================
[1/2] 检测Appium服务...
✗ Appium服务未运行
正在启动Appium服务...
等待Appium启动... (5/30秒)
✓ Appium服务启动成功 (耗时 6 秒)
[2/2] 检测ADB设备连接...
✗ ADB设备未找到: 127.0.0.1:52880
正在连接ADB设备: 127.0.0.1:52880...
✓ ADB连接成功: 127.0.0.1:52880
============================================================
验证修复结果...
✓ 所有连接修复成功！
============================================================
```

### 自动扫描端口日志
```
✗ ADB设备未找到: 127.0.0.1:52880
尝试自动扫描可用端口...
开始扫描常用ADB端口...
  尝试端口 59700...
  尝试端口 59701...
  尝试端口 59702...
  尝试端口 53709...
✓ 找到可用设备: 127.0.0.1:53709
✓ 端口已自动更新: 52880 → 53709
```

## 故障排查

### 问题1: Appium 启动失败
**错误信息**: `✗ Appium服务启动超时`

**解决方法**:
1. 确认已安装 Appium: `npm install -g appium`
2. 手动启动测试: `appium --address 127.0.0.1 --port 4723 --allow-cors`
3. 检查 4723 端口是否被占用: `netstat -ano | findstr 4723`

### 问题2: ADB 连接失败
**错误信息**: `✗ ADB设备未找到`

**解决方法**:
1. 确认红手指云手机已启动
2. 手动测试连接: `adb connect 127.0.0.1:52880`
3. 检查端口是否正确（红手指端口会变化）
4. 尝试点击 **"自动检测"** 按钮

### 问题3: WebDriver 创建超时
**错误信息**: `WebDriver会话创建超时`

**解决方法**:
1. 确认 Appium 和 ADB 都已正常运行
2. 检查大麦 App 是否已安装在设备上
3. 重启 Appium 服务
4. 重新连接 ADB 设备

## 技术细节

### 核心模块
- **`connection_auto_fixer.py`**: 连接自动修复核心模块
  - `ConnectionAutoFixer` 类：提供自动检测和修复功能
  - `ConnectionStatus` 数据类：存储连接状态

### 集成位置
1. **Smart GUI** (`damai_smart_ai.py:1615-1713`)
   - `connect_device()` 方法集成自动修复

2. **重构版 GUI** (`damai_gui_refactored.py:381-474`)
   - `start_bot()` 方法启动前自动检测

### 配置文件同步
系统会自动将检测到的端口同步到以下配置文件：
- `damai_appium/config.jsonc`
- `last_config.json`

## 测试建议

### 测试场景1: 正常连接
1. 确保 Appium 已运行，ADB 已连接
2. 输入正确端口，点击连接
3. 预期：快速连接成功

### 测试场景2: Appium 未启动
1. 关闭 Appium 服务
2. 点击连接
3. 预期：自动启动 Appium，然后连接成功

### 测试场景3: ADB 未连接
1. 断开 ADB 连接: `adb disconnect 127.0.0.1:52880`
2. 点击连接
3. 预期：自动连接 ADB，然后连接成功

### 测试场景4: 端口错误
1. 输入错误端口（如 `99999`）
2. 点击连接
3. 预期：自动扫描并找到正确端口

### 测试场景5: 红手指端口变化
1. 记录当前端口
2. 重启红手指（端口会变化）
3. 使用旧端口连接
4. 预期：自动检测新端口并连接

## 优势对比

### 修复前
- ❌ 需要手动启动 Appium
- ❌ 需要手动执行 `adb connect`
- ❌ 端口变化需要手动更新配置
- ❌ 连接失败需要手动排查问题

### 修复后
- ✅ 自动启动 Appium
- ✅ 自动连接 ADB
- ✅ 自动检测端口变化
- ✅ 智能诊断并修复连接问题
- ✅ 一键完成所有准备工作

## 注意事项

1. **首次使用**：首次启动 Appium 可能需要 30-60 秒，请耐心等待
2. **端口记录**：系统会自动记录最后成功连接的端口
3. **配置同步**：所有修复操作会自动更新配置文件
4. **日志查看**：建议查看详细日志了解连接状态
5. **红手指特性**：红手指端口会变化，建议使用自动检测功能

## 相关文件

- `connection_auto_fixer.py` - 核心修复模块
- `damai_smart_ai.py` - Smart GUI（主要使用）
- `damai_gui_refactored.py` - 重构版 GUI
- `environment_checker.py` - 环境检测模块
- `webdriver_manager.py` - WebDriver 管理模块

## 更新日期

2025-11-16
