# 本地屏幕监控 - 使用指南

## 方案优势 ⭐⭐⭐⭐⭐

✅ **不依赖ADB** - 无需连接云手机，避免超时
✅ **不依赖Appium** - 不需要保持session，更稳定
✅ **截图可靠** - 直接截取本地屏幕，不会失败
✅ **自动点击** - 检测到按钮直接用鼠标点击
✅ **极简实现** - 只需要3步配置即可运行

---

## 工作原理

```
1. 监控屏幕上云手机窗口的指定区域
   ↓
2. 实时检测该区域的颜色变化（红/橙色按钮出现）
   ↓
3. 检测到变化 → 自动点击购买按钮
```

---

## 安装依赖

```bash
pip install mss pyautogui opencv-python numpy
```

---

## 使用步骤

### 第1步：打开云手机窗口

1. 打开云手机客户端
2. 进入演出详情页
3. 将云手机窗口放到屏幕固定位置（监控期间不要移动）

### 第2步：校准坐标

运行校准工具：

```bash
python calibrate_screen.py
```

按照提示操作：
1. 移动鼠标到云手机窗口左上角 → 按Enter
2. 移动鼠标到购买按钮区域右下角 → 按Enter
3. 移动鼠标到购买按钮中心 → 按Enter

会自动生成配置代码，例如：

```python
BUTTON_MONITOR_REGION = {
    'top': 200,
    'left': 100,
    'width': 400,
    'height': 300
}

BUTTON_CLICK_POSITION = (300, 450)
```

### 第3步：更新配置并运行监控

将校准得到的配置代码复制到 `monitor_screen.py` 底部，替换示例配置。

然后运行监控：

```bash
python monitor_screen.py
```

监控开始后：
- 会实时显示检测状态
- 检测到购买按钮出现 → 自动点击3次
- 保存检测截图用于调试

---

## 配置参数说明

### 监控区域 (BUTTON_MONITOR_REGION)

```python
{
    'top': 200,      # 监控区域上边缘的Y坐标（屏幕坐标）
    'left': 100,     # 监控区域左边缘的X坐标（屏幕坐标）
    'width': 400,    # 监控区域宽度
    'height': 300    # 监控区域高度
}
```

**建议设置为购买按钮可能出现的区域**，通常是云手机窗口底部1/3区域。

### 点击位置 (BUTTON_CLICK_POSITION)

```python
(300, 450)  # (屏幕X坐标, 屏幕Y坐标)
```

**必须是购买按钮中心在屏幕上的绝对坐标。**

### 其他参数

```python
screen_monitor(
    monitor_region=BUTTON_MONITOR_REGION,
    click_position=BUTTON_CLICK_POSITION,
    threshold=0.05,      # 触发阈值：5%颜色变化即触发
    interval=0.5,        # 检查间隔：每0.5秒检查一次
    duration=300         # 监控时长：5分钟
)
```

- `threshold`: 颜色像素比例变化超过此值即触发（默认5%）
- `interval`: 检查间隔，越小响应越快，建议0.5秒
- `duration`: 监控时长（秒），0表示持续监控

---

## 典型场景

### 场景1：演出详情页等待开售

```python
# 监控购买按钮区域（云手机窗口底部）
BUTTON_MONITOR_REGION = {
    'top': 700,
    'left': 100,
    'width': 400,
    'height': 200
}

# 购买按钮中心坐标
BUTTON_CLICK_POSITION = (300, 850)

# 开始监控
screen_monitor(
    monitor_region=BUTTON_MONITOR_REGION,
    click_position=BUTTON_CLICK_POSITION,
    threshold=0.05,
    interval=0.3,   # 开售抢票用更短的间隔
    duration=600    # 监控10分钟
)
```

### 场景2：票档页等待余票

```python
# 监控确认订单按钮区域
BUTTON_MONITOR_REGION = {
    'top': 800,
    'left': 50,
    'width': 450,
    'height': 150
}

BUTTON_CLICK_POSITION = (275, 920)

screen_monitor(
    monitor_region=BUTTON_MONITOR_REGION,
    click_position=BUTTON_CLICK_POSITION,
    threshold=0.03,
    interval=0.5,
    duration=0  # 持续监控
)
```

---

## 常见问题

### Q1: 检测不到按钮？

**解决方法：**
- 调低 `threshold` 参数（例如改为0.03）
- 确保监控区域包含按钮
- 检查按钮颜色是否为红/橙色

### Q2: 误触发？

**解决方法：**
- 调高 `threshold` 参数（例如改为0.08）
- 缩小监控区域，只监控按钮位置

### Q3: 点击位置不准？

**解决方法：**
- 重新运行 `calibrate_screen.py` 校准
- 确保云手机窗口位置固定
- 监控期间不要移动云手机窗口

### Q4: 云手机窗口被遮挡？

**解决方法：**
- 确保云手机窗口在最前面
- 监控期间不要打开其他窗口遮挡
- 可以设置云手机窗口为"总是在最前"

---

## 进阶技巧

### 1. 保存监控日志

```bash
python monitor_screen.py > monitor.log 2>&1
```

### 2. 自定义颜色检测

如果购买按钮是其他颜色（如绿色），可以修改颜色阈值：

```python
# 绿色按钮
GREEN_THRESHOLDS = [
    ([40, 100, 100], [80, 255, 255]),  # 绿色HSV范围
]

screen_monitor(
    monitor_region=BUTTON_MONITOR_REGION,
    click_position=BUTTON_CLICK_POSITION,
    color_thresholds=GREEN_THRESHOLDS,
    # ...
)
```

### 3. 多次点击确保成功

在 `monitor_screen.py` 中修改点击次数：

```python
# 连续点击5次
for i in range(5):  # 原来是3次
    pyautogui.click(click_position[0], click_position[1])
    log(f"点击 #{i+1}", "OK")
    time.sleep(0.1)
```

---

## 与其他方案对比

| 方案 | 稳定性 | 响应速度 | 实现难度 | 推荐指数 |
|------|--------|----------|----------|----------|
| 屏幕监控 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| Page Source | ⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ |
| ADB UIAutomator | ⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐ |
| OpenCV元素监控 | ⭐⭐ | ⭐⭐⭐ | ⭐⭐ | ⭐⭐ |

**结论：如果使用云手机，屏幕监控是最佳方案！**

---

## 实战建议

1. **监控前准备**
   - 提前校准好坐标
   - 测试点击位置是否准确
   - 确保云手机窗口不会被遮挡

2. **开售前5分钟**
   - 打开云手机到演出详情页
   - 启动屏幕监控脚本
   - 不要移动云手机窗口

3. **检测成功后**
   - 脚本会自动点击
   - 立即手动确认是否进入购票流程
   - 后续手动操作完成支付

---

## 总结

**屏幕监控方案是监控云手机的最佳选择！**

✅ 简单：3步配置即可运行
✅ 稳定：不依赖ADB/Appium
✅ 可靠：本地截图不会失败
✅ 快速：每0.5秒检测一次

**立即开始使用：**

```bash
# 1. 安装依赖
pip install mss pyautogui opencv-python numpy

# 2. 校准坐标
python calibrate_screen.py

# 3. 运行监控
python monitor_screen.py
```
