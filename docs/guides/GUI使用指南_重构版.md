# 大麦抢票助手 GUI 使用指南 - v3.0.0 重构版

## 🎉 欢迎使用重构版GUI！

重构版GUI使用了全新的 DamaiBot v3.0.0 核心代码，具有以下优势：
- ✅ 代码量减少76% (1774行 → 423行)
- ✅ 模块化架构，6个独立模块
- ✅ 单元测试覆盖率35%+
- ✅ 更稳定、更易维护

---

## 🚀 快速开始

### 启动GUI
```bash
python damai_gui_refactored.py
```

---

## 📝 界面说明

### 1. 配置参数区域

**ADB端口**
- 当前设备端口：`53709`
- 如何查看：运行 `adb devices` 查看连接设备
- 示例：`127.0.0.1:53709` → 填写 `53709`

**城市**
- 默认：`北京`
- 支持：北京、上海、广州、深圳等所有城市
- 作用：首次启动时选择演出城市

**搜索关键词**
- 示例：`2025黎明`、`刘若英演唱会`、`周杰伦南京`
- 重要：关键词要准确，避免搜索结果过多

**价格档位**
- 范围：0-4
- 说明：
  - `0` = 最低价格
  - `1` = 第二低价格
  - `2` = 中等价格（默认）
  - `3` = 第二高价格
  - `4` = 最高价格

**启用自动重试**
- 勾选后可设置重试次数
- 建议：设置 2-3 次（避免过多重试）
- 失败后会自动重启APP重试

### 2. 控制按钮

**开始抢票**
- 点击后开始执行抢票流程
- 会自动保存配置
- 日志实时显示在下方

**停止抢票**
- 紧急停止按钮
- 会关闭Driver连接
- 建议：让程序自然完成

**保存配置**
- 将当前设置保存到 `config.jsonc`
- 下次启动自动加载

**清空日志**
- 清空日志显示区域
- 不影响程序运行

### 3. 状态信息

显示当前运行状态：
- 🟢 **就绪** - 等待开始
- 🟠 **运行中...** - 正在抢票
- 🟢 **抢票成功！** - 完成
- 🔴 **抢票失败** - 失败
- 🔴 **运行出错** - 错误
- 🟠 **已停止** - 手动停止

### 4. 运行日志

实时显示抢票过程：
- 🔵 **蓝色** - 普通信息 [INFO]
- 🟢 **绿色** - 成功操作 [OK]
- 🟡 **黄色** - 警告信息 [WARN]
- 🔴 **红色** - 错误信息 [ERROR]
- 🟣 **紫色** - 步骤信息 [STEP]

---

## 🎯 完整抢票流程

### 流程步骤

1. **启动准备**
   - 连接Appium服务器
   - 连接Android设备
   - 初始化所有模块

2. **APP控制**
   - 重启大麦APP
   - 等待APP完全启动
   - 关闭启动页广告

3. **搜索演出**
   - 进入搜索页面
   - 输入搜索关键词
   - 点击搜索结果

4. **选择票档**
   - 点击"立即购票"按钮
   - 选择场次（第一个有票场次）
   - 选择票档（根据价格档位）

5. **确认订单**
   - 点击"确认"按钮
   - 进入订单页面
   - 抢票完成

### 预计时间

- **正常流程**：20-40秒
- **包含重试**：1-3分钟
- **初次连接**：30-60秒（含Driver初始化）

---

## 💡 使用技巧

### 1. 提前准备

**在开售前5分钟**：
- ✅ 启动Appium服务器
- ✅ 连接好Android设备
- ✅ 配置好所有参数
- ✅ 测试一次确保流程正常
- ✅ 清空日志准备正式抢票

**配置检查**：
```bash
# 检查ADB连接
adb devices

# 检查Appium服务
netstat -ano | findstr "4723"

# 测试连接
python test_refactored_bot.py
```

### 2. 关键词选择

**准确匹配**：
- ✅ 好：`2025黎明南京演唱会`
- ❌ 差：`黎明`（结果太多）

**避免特殊字符**：
- ✅ 好：`周杰伦2025`
- ❌ 差：`周杰伦【2025】`

### 3. 价格档位策略

**抢热门演出**：
- 建议选择 `0` 或 `1`（低价位）
- 成功率更高

**抢普通演出**：
- 可以选择 `2`（中等价位）
- 性价比最佳

**不在乎价格**：
- 选择 `3` 或 `4`（高价位）
- 几乎必然有票

### 4. 重试策略

**首次抢票**：
- 设置重试次数：`2-3`
- 避免过多重试影响其他用户

**二次开售**：
- 设置重试次数：`5-10`
- 捡漏机会更大

---

## 🔧 故障排除

### 问题1：无法连接设备

**症状**：
```
[ERROR] Driver连接失败
```

**解决**：
```bash
# 重新连接ADB
adb disconnect
adb connect 127.0.0.1:53709

# 检查连接
adb devices
```

### 问题2：APP启动失败

**症状**：
```
[ERROR] APP未就绪
```

**解决**：
1. 手动打开大麦APP确认能启动
2. 检查设备存储空间
3. 清理APP缓存
4. 重启模拟器/设备

### 问题3：搜索结果为空

**症状**：
```
[WARN] 未找到搜索结果
```

**解决**：
1. 检查关键词是否正确
2. 确认演出是否已上线
3. 尝试更简短的关键词
4. 检查城市选择是否正确

### 问题4：无法选择票档

**症状**：
```
[WARN] 所有场次/票档都无票
```

**解决**：
1. 演出可能已售罄
2. 尝试降低价格档位
3. 等待补票重试
4. 检查是否在开售时间

### 问题5：GUI界面无响应

**症状**：
- 点击按钮无反应
- 界面卡死

**解决**：
```bash
# 强制关闭
taskkill /F /IM python.exe

# 重新启动
python damai_gui_refactored.py
```

---

## 📊 日志解读

### 正常流程日志示例

```
============================================================
[STEP] 步骤 0: 初始化大麦抢票Bot
============================================================
[INFO] 加载配置文件...
[OK] 配置加载成功: 关键词='2025黎明', 城市='北京'
[INFO] 初始化Appium WebDriver...
[OK] WebDriver初始化成功!

============================================================
[STEP] 步骤 1: 重启大麦APP确保初始状态
============================================================
[INFO] 关闭大麦APP...
[OK] 大麦APP已关闭
[INFO] 启动大麦APP...
[OK] 大麦APP已启动并就绪

[INFO] 尝试并关闭广告弹窗
[OK] 广告弹窗已关闭

============================================================
[STEP] 步骤 3: 搜索演出
============================================================
[INFO] 搜索关键词: 2025黎明
[OK] 搜索成功

[OK] 点击搜索结果成功

============================================================
[STEP] 步骤 5: 选择场次和票档
============================================================
[OK] 场次选择成功
[OK] 票档选择成功

[OK] *** 抢票流程执行成功! ***
```

### 常见错误日志

**连接错误**：
```
[ERROR] WebDriver连接失败
[ERROR] 原因: Connection refused
→ 检查Appium服务是否启动
```

**元素未找到**：
```
[WARN] 未找到购票按钮
[INFO] 可能页面未加载完成
→ 等待页面加载或检查页面状态
```

**超时错误**：
```
[ERROR] 等待元素超时
→ 网络慢或页面异常
```

---

## 🎨 GUI特性

### 1. 深色主题日志
- 护眼设计
- 代码级别的可读性
- 清晰的颜色标记

### 2. 实时日志更新
- 每100ms刷新
- 不阻塞UI
- 自动滚动到最新

### 3. 智能状态管理
- 按钮状态自动切换
- 防止重复启动
- 优雅的错误处理

### 4. 配置持久化
- 自动保存最后配置
- 下次启动自动加载
- JSON格式易于编辑

---

## 🔍 高级功能

### 1. 日志捕获机制
GUI会捕获所有BotLogger输出并显示在界面上，无需查看控制台。

### 2. 线程安全设计
抢票在独立线程运行，不会阻塞GUI响应。

### 3. 优雅退出
关闭窗口时自动清理Driver连接，不留残留进程。

---

## 📞 技术支持

### 重构版特性
- 6个独立模块：Constants、ElementFinder、PopupHandler、NavigationHelper、TicketSelector、DamaiBot
- 132个单元测试
- 35%代码覆盖率
- 完整的类型注解

### 文档
- `REFACTORING_SUMMARY.md` - 重构总结
- `test_refactored_bot.py` - 功能测试脚本
- `tests/unit/` - 单元测试

### 测试命令
```bash
# 运行单元测试
python -m pytest tests/unit/ -v

# 运行功能测试
python test_refactored_bot.py

# 查看覆盖率
python -m pytest --cov
```

---

## 🎊 版本信息

**版本**: v3.0.0
**发布日期**: 2025-11-16
**核心**: DamaiBot Refactored
**代码优化**: -76% 行数
**性能提升**: ~10x
**测试覆盖**: 35.23%

---

**祝你抢票成功！🎉**
