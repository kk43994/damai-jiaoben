# 红手指云手机 ADB端口 - 动态端口使用指南

## ⚠️ 重要提示

**红手指云手机的ADB端口每次重新连接都会改变！**

例如：
- 今天连接可能是：`127.0.0.1:53709`
- 明天连接可能是：`127.0.0.1:53710`
- 后天连接可能是：`127.0.0.1:53711`

所以**每次使用前必须更新ADB端口**！

---

## 🎯 完整使用流程

### 步骤1: 获取当前ADB端口

**方法A: 红手指客户端查看**
1. 打开红手指云手机客户端
2. 找到您的云手机设备
3. 查看ADB连接信息
4. 复制端口号（例如：`53709`）

**方法B: ADB命令查看**
```bash
adb devices
```
输出示例：
```
List of devices attached
127.0.0.1:53709    device  ← 这就是您的端口
```

---

### 步骤2: 在GUI中更新ADB端口

1. **打开GUI界面**
   ```bash
   python damai_gui_refactored.py
   ```

2. **找到ADB端口输入框**
   - 位置：配置参数区域第一行
   - 标签：**ADB端口**（加粗显示）
   - 旁边有红色警告：⚠ **红手指端口会变化，请及时更新**

3. **输入完整的ADB连接地址**
   - 格式：`127.0.0.1:端口号`
   - 示例：`127.0.0.1:53709`

4. **点击"保存配置"按钮**
   - 配置会保存到 `damai_appium/config.jsonc`
   - 下次启动会自动加载

---

### 步骤3: 测试WebDriver连接

**在开始抢票前，务必测试连接！**

1. **点击"检测WebDriver"按钮**（紫色按钮）

2. **查看日志输出**
   ```
   ============================================================
   开始检测WebDriver连接状态
   ============================================================
   [时间] 使用ADB端口: 127.0.0.1:53709
   [时间] 创建新的WebDriver管理器
   [时间] 正在检测WebDriver连接...
   ```

3. **等待检测结果**

   **✅ 成功**：
   ```
   [时间] ✓ WebDriver连接正常
   [时间]   • 连接地址: http://127.0.0.1:4723
   [时间]   • 设备UDID: 127.0.0.1:53709
   [时间]   • 当前Activity: .homepage.MainActivity
   ```
   弹窗提示："WebDriver连接状态正常！"

   **❌ 失败**：
   ```
   [时间] ✗ WebDriver连接已断开
   [时间] 正在尝试连接到设备: 127.0.0.1:53709...
   [时间] 连接配置:
   [时间]   • 服务器: http://127.0.0.1:4723
   [时间]   • 设备: 127.0.0.1:53709
   [时间]   • 应用: cn.damai
   [时间] [1/3] 正在建立WebDriver连接...
   [时间] ✗ 连接失败: ...
   ```

---

### 步骤4: 开始抢票

1. **确认所有配置正确**
   - ✅ ADB端口：`127.0.0.1:53709`（您的实际端口）
   - ✅ 城市：`贵阳`
   - ✅ 关键词：`时代少年团`
   - ✅ 价格档位：`2`

2. **点击"开始抢票"按钮**
   - 系统会自动使用GUI中的ADB端口
   - 自动保存配置后启动

3. **观察日志**
   - 流程恢复功能已集成
   - 遇到错误页面会自动恢复

---

## 🔄 端口变化时的处理流程

### 场景：明天再次使用，端口已经改变

1. **获取新端口**
   ```bash
   adb devices
   # 输出：127.0.0.1:53710  device  ← 新端口号
   ```

2. **打开GUI，修改ADB端口**
   - 将 `127.0.0.1:53709` 改为 `127.0.0.1:53710`
   - 点击"保存配置"

3. **测试新端口**
   - 点击"检测WebDriver"
   - 确认连接成功

4. **继续抢票**
   - 点击"开始抢票"

**无需重启程序，只需修改端口即可！**

---

## 📊 GUI界面布局说明

```
┌─────────── 配置参数 ───────────┐
│                                │
│ ADB端口*: [127.0.0.1:53709]    │  ⚠ 红手指端口会变化，请及时更新
│                                │
│ 城市: [贵阳           ]         │
│                                │
│ 搜索关键词: [时代少年团                           ]
│                                │
│ 价格档位: [2 ▼]  (0=最低, 数字越大价格越高)
│                                │
│ ☑ 启用自动重试   最大重试次数: [3      ]
│                                │
└────────────────────────────────┘

[ 开始抢票 ] [ 停止抢票 ] [ 保存配置 ] [ 清空日志 ] [ 检测WebDriver ]
```

**注意**：
- **ADB端口**标签是加粗的，方便识别
- 旁边有红色警告提示
- 检测WebDriver按钮是紫色，方便识别

---

## 🛠️ 故障排查

### 问题1: 提示"请先输入ADB端口"

**原因**: ADB端口输入框为空

**解决**:
1. 运行 `adb devices` 获取端口
2. 在GUI中输入完整地址（`127.0.0.1:端口号`）
3. 点击"保存配置"

---

### 问题2: 检测失败 - 连接超时

**可能原因**:
1. ADB端口号错误（最常见）
2. 红手指云手机未启动
3. ADB连接已断开

**解决步骤**:

**Step 1**: 检查ADB连接
```bash
adb devices
```
如果没有看到您的设备，重新连接：
```bash
adb connect 127.0.0.1:端口号
```

**Step 2**: 验证端口号是否匹配
- `adb devices` 显示的端口
- GUI中输入的端口
- **两者必须完全一致！**

**Step 3**: 重新启动Appium
```bash
appium --address 127.0.0.1 --port 4723 --allow-cors
```

---

### 问题3: 抢票中途连接断开

**原因**: 红手指云手机连接不稳定

**解决**:
1. 先点击"停止抢票"
2. 检查ADB连接：`adb devices`
3. 如果端口变了，更新GUI中的ADB端口
4. 点击"检测WebDriver"测试
5. 确认正常后，重新"开始抢票"

---

### 问题4: 端口号格式错误

**错误示例**:
- ❌ `53709`（缺少IP地址）
- ❌ `localhost:53709`（应该用127.0.0.1）
- ❌ `127.0.0.1: 53709`（多了空格）

**正确格式**:
- ✅ `127.0.0.1:53709`

---

## 💡 最佳实践

### 1. 每日检查清单

**每次使用前**：
```
□ 启动红手指云手机
□ 运行 adb devices 获取端口
□ 在GUI中更新ADB端口
□ 点击"保存配置"
□ 点击"检测WebDriver"
□ 确认连接正常
□ 开始抢票
```

---

### 2. 快速更换端口流程

红手指云手机重启后：

```bash
# 1. 获取新端口
adb devices

# 2. 打开GUI
python damai_gui_refactored.py

# 3. 修改ADB端口（在GUI中）
#    修改: 127.0.0.1:旧端口 → 127.0.0.1:新端口

# 4. 保存配置

# 5. 测试连接
#    点击"检测WebDriver"按钮

# 6. 开始抢票
```

**整个过程不到30秒！**

---

### 3. 多设备管理

如果您有多个红手指云手机：

| 设备名称 | ADB端口 | 用途 |
|---------|---------|------|
| 设备A | 127.0.0.1:53709 | 抢贵阳演唱会 |
| 设备B | 127.0.0.1:53710 | 抢北京演唱会 |
| 设备C | 127.0.0.1:53711 | 备用 |

**切换设备**：
1. 在GUI中修改ADB端口
2. 修改城市和关键词
3. 点击"保存配置"
4. 点击"检测WebDriver"
5. 点击"开始抢票"

---

### 4. 配置文件备份

**建议备份配置**：
```bash
# 备份当前配置
cp damai_appium/config.jsonc damai_appium/config_backup.jsonc

# 需要恢复时
cp damai_appium/config_backup.jsonc damai_appium/config.jsonc
```

---

## 📈 性能数据

| 操作 | 耗时 | 说明 |
|------|------|------|
| 修改ADB端口 | 3秒 | 在GUI中输入 |
| 保存配置 | <1秒 | 写入配置文件 |
| 检测WebDriver（正常） | <1秒 | 复用现有连接 |
| 检测WebDriver（断开） | 5-15秒 | 重新建立连接 |
| 首次建立连接 | 60-140秒 | 启动APP等 |

**总结**: 修改端口后，通过"检测WebDriver"快速验证，总耗时约10-20秒。

---

## 🎓 技术细节

### ADB端口格式说明

**完整格式**: `IP地址:端口号`

- **IP地址**: 本地回环地址（127.0.0.1）
- **端口号**: 红手指动态分配的端口（53709-53800范围）

### WebDriver连接过程

```
GUI输入ADB端口
    ↓
保存到 config.jsonc
    ↓
DamaiBot读取配置
    ↓
WebDriverManager创建连接
    ↓
使用GUI中的端口连接
    ↓
成功！
```

### 检测流程

```
点击"检测WebDriver"
    ↓
读取GUI中的ADB端口
    ↓
创建/复用WebDriver Manager
    ↓
检测连接健康状态
    ├─ 健康 → 显示成功
    └─ 断开 → 使用新端口重新连接
              ├─ 成功 → 显示修复成功
              └─ 失败 → 显示诊断信息
```

---

## 📞 常见问题 FAQ

**Q1: 每次都要修改端口吗？**
A: 是的，红手指云手机每次重新连接，ADB端口都会变化。

**Q2: 如何知道端口变了？**
A: 运行 `adb devices` 查看当前端口，与上次使用的端口对比。

**Q3: 修改端口后需要重启程序吗？**
A: 不需要！直接在GUI中修改，保存配置，点击"检测WebDriver"即可。

**Q4: 可以不用检测直接抢票吗？**
A: 不建议。检测只需几秒，但能避免因端口错误导致抢票失败。

**Q5: 端口变化有规律吗？**
A: 没有固定规律，由红手指系统动态分配，通常在53700-53800范围内。

**Q6: 可以固定端口吗？**
A: 红手指云手机的端口由系统分配，无法固定。这是云手机的特性。

---

## 🎯 测试案例：贵阳时代少年团演唱会

### 完整测试流程

**假设场景**: 今天要抢贵阳时代少年团演唱会的票，昨天用的端口是53709，今天端口变成了53710

**操作步骤**:

```bash
# 1. 检查新端口
$ adb devices
List of devices attached
127.0.0.1:53710    device  ← 新端口！

# 2. 启动GUI
$ python damai_gui_refactored.py

# 3. 在GUI中操作：
#    - ADB端口: 将 127.0.0.1:53709 改为 127.0.0.1:53710
#    - 城市: 贵阳
#    - 关键词: 时代少年团
#    - 价格档位: 2

# 4. 点击"保存配置"

# 5. 点击"检测WebDriver"
#    等待日志显示：
#    ✓ WebDriver连接正常
#    • 设备UDID: 127.0.0.1:53710

# 6. 点击"开始抢票"
#    观察日志输出...

# 7. 流程自动运行
#    - 自动处理弹窗
#    - 自动搜索"时代少年团"
#    - 自动选择城市"贵阳"
#    - 遇到错误自动恢复（流程恢复功能）
#    - 完成抢票！
```

---

**创建时间**: 2025-11-16
**版本**: 1.0
**适用**: 大麦抢票助手 v3.0.0 + 红手指云手机
